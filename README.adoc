# Post-Quantum WebAuthn Test Platform

**Deployed Web Service:**  https://python-fido2-webauthn-test.onrender.com

**Note:** The Docker image in this repo builds `liboqs` and its Python bindings from source so the
demo is PQC-ready without any host-level setup.

== üö¢ Containerised deployment

The repository now contains a multi-stage `Dockerfile` that builds liboqs from source, compiles the
matching `liboqs-python` bindings, and runs the Flask demo with Gunicorn.  This container is
self-contained and works on Render or any other Docker-capable platform.

=== Build the image

[,shell]
----
docker build -t webauthn-pqc .
----

=== Run locally

[,shell]
----
docker run --rm -p 8000:8000 webauthn-pqc
----

The container uses the `PORT` environment variable when supplied by a hosting service, defaulting to
`8000` for local testing.  liboqs is installed under `/opt/liboqs` and made available to the
`oqs` Python package automatically, so Post-Quantum algorithms can be exercised without any manual
host configuration.  The Flask demo is served via Gunicorn using the command
`gunicorn --bind 0.0.0.0:${PORT:-8000} server.app:app`.

=== Deploying on Render

`render.yaml` is already configured to build from the Dockerfile, so deploying this repo on Render
will automatically compile liboqs/liboqs-python and start Gunicorn bound to the platform-provided
port. When creating or updating the service in Render:

1. Choose the **Docker** environment (Render labels this as ‚ÄúRuntime: Docker‚Äù) and point it at this
   repository. If you already created the service with the Python runtime, delete and recreate it so
   the Docker runtime is used‚Äîseeing logs such as ‚ÄúUsing Python version ‚Ä¶‚Äù means Render is still on
   the non-container runtime and will fail with `docker: command not found`.
2. Leave the **Build Command** and **Start Command** fields empty so Render executes the Dockerfile
   directly; the container already starts Gunicorn for you.
3. Confirm that the generated container image starts with `gunicorn --bind 0.0.0.0:${PORT:-8000}
   server.app:app`, which exposes PQC-capable WebAuthn endpoints using the bundled `oqs`
   dependency.

==== Fallback: Render's native Python runtime

Some Render accounts cannot switch an existing service to the Docker runtime immediately. If the
build logs still show ‚ÄúUsing Python version ‚Ä¶‚Äù and the deployment fails with
`docker: command not found`, configure the service with the following commands instead:

[,text]
----
Build Command: ./render-build.sh
Start Command: ./render-start.sh
----

These scripts recreate the Docker build steps inside Render's native environment by compiling
`liboqs` from source, installing the matching `liboqs-python` bindings, and launching Gunicorn with
the required `LD_LIBRARY_PATH`/`LIBOQS_DIR` settings. The resulting deployment exposes the same PQC
algorithms as the container image, so you can keep validating WebAuthn flows while you migrate to
Render's Docker runtime.

A complete test suite for WebAuthn/FIDO2 registration and authentication with Post-Quantum Cryptography (PQC) support.
It displays the selected algorithm, authenticator flags (UP/UV/AT/ED/BE/BS), sign counter, and extension results (credProps, PRF, largeBlob) for validation.  
This test app also supports functionalities such as **decoder**, **FIDO MDS explorer**, etc.  

Built on **python-fido2-PQC**, which extends Yubico‚Äôs **python-fido2**.  

PQC: Currently supporting **ML-DSA-44** (alg: -48), **ML-DSA-65** (alg: -49), and **ML-DSA-87** (alg: -50). 

---

## üíª Local Setup

**Scope**
- Includes: Python, virtual environment, Flask, python-fido2, and Post-Quantum Crypto (PQC) algorithm options.

---

## ‚úÖ Supported Platforms

- Windows 10/11 (64-bit)  
- macOS (Intel or Apple Silicon)  

A modern browser with WebAuthn support is required:
- Edge, Chrome, Safari, Firefox

---

## 1. Prerequisites

- **Git**: (https://git-scm.com/)  
- **Python 3.12+ (64-bit)** with pip (https://www.python.org/downloads/)

---

## 2. Clone the Repository

```bash
git clone https://github.com/rainzhang05/python-fido2-webauthn-test.git
cd python-fido2-webauthn-test
```

---

## 3. Setup ‚Äî pip + venv

### Windows (PowerShell)

```powershell
# Create and activate a virtual environment
py -3.12 -m venv .venv
.\.venv\scripts\activate

# Upgrade pip and install runtime dependencies
python -m pip install --upgrade pip
pip install -r requirements.txt

# Optional: PC/SC smart card extras
pip install "fido2[pcsc]"
```

### macOS

```bash
# Create and activate a virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Upgrade pip and install runtime dependencies
python -m pip install --upgrade pip
pip install -r requirements.txt

# Optional: PC/SC smart card extras
pip install "fido2[pcsc]"
```

## üîê PQC Setup

### 1. Activate Your Python Virtual Environment

**Windows (PowerShell):**
```powershell
.\.venv\scripts\activate
```

**macOS:**
```bash
source .venv/bin/activate
```

### 2. Install PQC Cryptography Libraries

**Using pip / virtualenv**
```bash
pip install ".[pqc]"
python -c "import oqs"
```
### 3. Install Open Quantum Safe (OQS) Libraries: 

#### Install `liboqs`

##### Windows

```powershell
# Clone liboqs
git clone --branch main https://github.com/open-quantum-safe/liboqs.git
cd liboqs

# Configure build
cmake -S . -B build -DOQS_BUILD_SHARED_LIBS=ON -DOQS_USE_OPENSSL=OFF

# Build in Release mode
cmake --build build --config Release
```
Output: build\bin\Release\oqs.dll

Copy the DLL into your Python venv so oqs can find it:

```
copy build\bin\Release\oqs.dll C:\path\to\your\venv\Lib\site-packages\oqs\
```

Or add the folder to your PATH.

##### macOS
```
# Clone liboqs
git clone --branch main https://github.com/open-quantum-safe/liboqs.git
cd liboqs

# Configure and build
cmake -S . -B build -DOQS_BUILD_SHARED_LIBS=ON -DOQS_USE_OPENSSL=OFF
cmake --build build --config Release
```

Output: build/lib/liboqs.dylib

Copy to your venv:

```
cp build/lib/liboqs.dylib /path/to/venv/lib/python3.X/site-packages/oqs/
```

Or add to DYLD_LIBRARY_PATH:

```
export DYLD_LIBRARY_PATH=$PWD/build/lib:$DYLD_LIBRARY_PATH
```

#### 4. Install liboqs-python

Make sure you already built and installed **liboqs** (the C library).  
Now, clone and install the Python wrapper:

```bash
# Go to home directory
cd ~

# Clone liboqs-python
git clone https://github.com/open-quantum-safe/liboqs-python.git
cd liboqs-python

# Install into your active virtual environment
pip install .
```

#### Step 2. Verify Installation

From your **project root** (where your `.venv` is located):

```bash
cd ~/IdeaProjects/python-fido2-webauthn-test
python -c "import oqs; print(oqs.get_version()); print(oqs.get_enabled_sigs())"
```

If installed correctly, you should see something like: 
```
0.14.0-dev
['ML-DSA-44', 'ML-DSA-65', 'ML-DSA-87', ...]
```
This indicates the version number and supported algorithms. Make sure all PQC algorithm that you would like to use appears in the list above. 

---

## üîí mkcert Setup for Local HTTPS

### 1. Install mkcert

#### Windows
```bash
# Install Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force; `
  [System.Net.ServicePointManager]::SecurityProtocol = `
  [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; `
  iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
# Install mkcert via Chocolatey
choco install mkcert -y
```

#### macOS
```bash
brew install mkcert
brew install nss   # required for Firefox users
mkcert -install
```

---

### 2. Generate Certificates

**Windows (PowerShell)**
```powershell
cd C:\path\to\your\project
mkcert localhost 127.0.0.1 ::1
```

**macOS (Terminal)**
```bash
cd /path/to/your/project
mkcert localhost 127.0.0.1 ::1
```

‚ö†Ô∏è Important:
- WebAuthn works on `localhost`, **not** `127.0.0.1`.  
- Rename files to:
  - `localhost+1.pem`  
  - `localhost+1-key.pem`  
  Otherwise, the program will fail to run.

---

## üöÄ Quickstart

### 1. Create and Activate Virtual Environment

**Windows (PowerShell)**
```powershell
py -3 -m venv .venv
.\.venv\scripts\activate
```

**macOS**
```bash
python3 -m venv .venv
source .venv/bin/activate
```

---

### 2. Run the Server

```bash
python server/server/app.py
```

Expected output:
```
Running on https://localhost:5000/
```

Click the link to open the test app in your browser.

---

## üìù Notes

- Credentials are saved as `.pkl` files in:  
  `server/server`  
- Deleting credentials in the test app will also delete the corresponding `.pkl` file locally.

---
