# Post-Quantum WebAuthn Test Platform

**Deployed Web Service:**  https://python-fido2-webauthn-test.onrender.com

## üîÅ Automated FIDO Metadata Service updates

- The Flask demo no longer downloads or verifies the FIDO Metadata Service (MDS) during request handling or process start-up. It always consumes the most recent verified snapshot written by a background job.
- A Render cron job (defined in `render.yaml`) runs `python -m server.scripts.refresh_mds_cache` daily. The script downloads the latest MDS JWT, verifies it against the FIDO trust root, serialises the parsed payload, and atomically updates the cached files.
- Verified data and download headers are stored under the shared state directory (`STATE_DATA_ROOT`). By default this points to `/data/fido-metadata` on Render so both the web service and cron container see the same persistent volume. Local development falls back to `server/server/state/`.
- The cron job preserves the previous snapshot if a refresh fails. The web UI simply reads the cached JSON/JWS; if no snapshot exists yet it shows an informational message rather than trying to fetch the metadata itself.
- Runtime observability: the cron script logs start/end markers, download size, entry counts, and cache timestamps so Render‚Äôs job logs confirm successful updates.

## üíª Local Setup

**Scope**
- Includes: Python, virtual environment, Flask, python-fido2, and Post-Quantum Crypto (PQC) algorithm options.

---

## ‚úÖ Supported Platforms

- Windows 10/11 (64-bit)  
- macOS (Intel or Apple Silicon)  

A modern browser with WebAuthn support is required:
- Edge, Chrome, Safari, Firefox

---

## 1. Prerequisites

- **Git**: (https://git-scm.com/)  
- **Python 3.12+ (64-bit)** with pip (https://www.python.org/downloads/)

---

## 2. Clone the Repository

```bash
git clone https://github.com/rainzhang05/python-fido2-webauthn-test.git
cd python-fido2-webauthn-test
```

---

## 3. Setup ‚Äî pip + venv

### Windows (PowerShell)

```powershell
# Create and activate a virtual environment
py -3.12 -m venv .venv
.\.venv\scripts\activate

# Upgrade pip and install runtime dependencies
python -m pip install --upgrade pip
pip install -r requirements.txt

# Optional: PC/SC smart card extras
pip install "fido2[pcsc]"
```

### macOS

```bash
# Create and activate a virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Upgrade pip and install runtime dependencies
python -m pip install --upgrade pip
pip install -r requirements.txt

# Optional: PC/SC smart card extras
pip install "fido2[pcsc]"
```

## üîê PQC Setup

### 1. Activate Your Python Virtual Environment

**Windows (PowerShell):**
```powershell
.\.venv\scripts\activate
```

**macOS:**
```bash
source .venv/bin/activate
```

### 2. Install PQC Cryptography Libraries

**Using pip / virtualenv**
```bash
pip install ".[pqc]"
python -c "import oqs"
```
### 3. Install Open Quantum Safe (OQS) Libraries: 

#### Install `liboqs`

##### Windows

```powershell
# Clone liboqs
git clone --branch main https://github.com/open-quantum-safe/liboqs.git
cd liboqs

# Configure build
cmake -S . -B build -DOQS_BUILD_SHARED_LIBS=ON -DOQS_USE_OPENSSL=OFF

# Build in Release mode
cmake --build build --config Release
```
Output: build\bin\Release\oqs.dll

Copy the DLL into your Python venv so oqs can find it:

```
copy build\bin\Release\oqs.dll C:\path\to\your\venv\Lib\site-packages\oqs\
```

Or add the folder to your PATH.

##### macOS
```
# Clone liboqs
git clone --branch main https://github.com/open-quantum-safe/liboqs.git
cd liboqs

# Configure and build
cmake -S . -B build -DOQS_BUILD_SHARED_LIBS=ON -DOQS_USE_OPENSSL=OFF
cmake --build build --config Release
```

Output: build/lib/liboqs.dylib

Copy to your venv:

```
cp build/lib/liboqs.dylib /path/to/venv/lib/python3.X/site-packages/oqs/
```

Or add to DYLD_LIBRARY_PATH:

```
export DYLD_LIBRARY_PATH=$PWD/build/lib:$DYLD_LIBRARY_PATH
```

#### 4. Install liboqs-python

Make sure you already built and installed **liboqs** (the C library).  
Now, clone and install the Python wrapper:

```bash
# Go to home directory
cd ~

# Clone liboqs-python
git clone https://github.com/open-quantum-safe/liboqs-python.git
cd liboqs-python

# Install into your active virtual environment
pip install .
```

#### Step 2. Verify Installation

From your **project root** (where your `.venv` is located):

```bash
cd ~/IdeaProjects/python-fido2-webauthn-test
python -c "import oqs; print(oqs.get_version()); print(oqs.get_enabled_sigs())"
```

If installed correctly, you should see something like: 
```
0.14.0-dev
['ML-DSA-44', 'ML-DSA-65', 'ML-DSA-87', ...]
```
This indicates the version number and supported algorithms. Make sure all PQC algorithm that you would like to use appears in the list above. 

---

## üîí mkcert Setup for Local HTTPS

### 1. Install mkcert

#### Windows
```bash
# Install Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force; `
  [System.Net.ServicePointManager]::SecurityProtocol = `
  [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; `
  iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
# Install mkcert via Chocolatey
choco install mkcert -y
```

#### macOS
```bash
brew install mkcert
brew install nss   # required for Firefox users
mkcert -install
```

---

### 2. Generate Certificates

**Windows (PowerShell)**
```powershell
cd C:\path\to\your\project
mkcert localhost 127.0.0.1 ::1
```

**macOS (Terminal)**
```bash
cd /path/to/your/project
mkcert localhost 127.0.0.1 ::1
```

‚ö†Ô∏è Important:
- WebAuthn works on `localhost`, **not** `127.0.0.1`.  
- Rename files to:
  - `localhost+1.pem`  
  - `localhost+1-key.pem`  
  Otherwise, the program will fail to run.

---

## üöÄ Quickstart

### 1. Create and Activate Virtual Environment

**Windows (PowerShell)**
```powershell
py -3 -m venv .venv
.\.venv\scripts\activate
```

**macOS**
```bash
python3 -m venv .venv
source .venv/bin/activate
```

---

### 2. Run the Server

```bash
python server/server/app.py
```

Expected output:
```
Running on https://localhost:5000/
```

Click the link to open the test app in your browser.

---

## üìù Notes

- Credentials are saved as `.pkl` files in:  
  `server/server`  
- Deleting credentials in the test app will also delete the corresponding `.pkl` file locally.

---
