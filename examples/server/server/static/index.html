<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn FIDO2 Test Application</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #325F74 0%, #4a7b8e 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 300;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .container {
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            transition: all 0.3s ease;
            border-right: 1px solid #dee2e6;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: white;
            color: #325F74;
            font-weight: 500;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
        }

        .content {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h2 {
            color: #325F74;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #325F74;
            box-shadow: 0 0 0 3px rgba(50, 95, 116, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #325F74;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background: #2a4e5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .status {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            min-width: 300px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background: #cce7ff;
            border: 1px solid #b3d7ff;
            color: #004085;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 2fr 0.8fr;
            gap: 2rem;
            margin-top: 1rem;
            align-items: start;
            width: 100%;
        }

        .three-column > div {
            align-self: start;
            min-width: 0; /* Prevent grid overflow */
        }

        .form-column, .json-editor-column, .credentials-column {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .form-column h3, .json-editor-column h3, .credentials-column h3 {
            margin-bottom: 1rem;
            color: #325F74;
            font-size: 1.1rem;
            height: 1.5rem; /* Fixed height for alignment */
        }

        .sub-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .sub-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .sub-tab.active {
            background: white;
            color: #325F74;
            font-weight: 500;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .sub-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .form-control.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .credentials-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            min-height: 600px;
            max-height: 600px;
            overflow-y: auto;
        }

        .credentials-panel h3 {
            margin-bottom: 1rem;
            color: #325F74;
            font-size: 1.1rem;
        }

        .credential-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .credential-item:hover {
            border-color: #325F74;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .credential-item.expanded {
            border-color: #325F74;
        }

        .credential-summary {
            font-weight: 500;
            color: #495057;
        }

        .credential-details {
            display: none;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .credential-item.expanded .credential-details {
            display: block;
        }

        .credential-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            float: right;
            margin-top: 0.5rem;
        }

        .credential-delete:hover {
            background: #c82333;
        }

        .expandable-section {
            margin-bottom: 1rem;
        }

        .section-header {
            cursor: pointer;
            padding: 0.75rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header.expanded {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            background: #e9ecef;
        }

        .section-content {
            display: none;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: white;
        }

        .section-content.expanded {
            display: block;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .json-editor {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 0.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 600px;
            white-space: pre-wrap;
        }

        .json-editor textarea {
            width: 100%;
            height: 100%;
            min-height: 600px;
            background: transparent;
            border: none;
            outline: none;
            resize: vertical;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress {
            display: none;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-align: center;
            margin-top: 1rem;
        }

        .progress.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(50, 95, 116, 0.3);
            border-radius: 50%;
            border-top-color: #325F74;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        select.form-control {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 12px;
        }

        .alert-info {
            color: #055160;
            background-color: #cff4fc;
            border-color: #b6effb;
        }

        .refresh-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #325F74;
            border-top: 2px solid transparent;
            border-radius: 50%;
            background: none;
            padding: 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .refresh-icon:hover {
            transform: rotate(180deg);
        }

        .btn.refresh-icon {
            min-width: auto;
            width: 32px;
            height: 32px;
            border: 2px solid #325F74;
            border-top: 2px solid transparent;
            border-radius: 50%;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn.refresh-icon:hover {
            background: #f8f9fa;
            transform: rotate(180deg);
        }

        .btn.refresh-icon:before {
            content: '';
        }

        /* For screens above 600px - three columns */
        @media (min-width: 601px) {
            .three-column {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 2rem;
            }
        }

        /* For screens 481px to 600px - two columns */
        @media (max-width: 600px) and (min-width: 481px) {
            .three-column {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
        }

        /* For screens below 480px - single column */
        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }

            .two-column,
            .three-column {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .nav-tab:last-child {
                border-bottom: none;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: #325F74;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #495057;
        }

        .modal-body {
            line-height: 1.6;
        }

        .modal-body p {
            margin-bottom: 0.75rem;
        }

        .modal-body strong {
            color: #495057;
        }

        .modal-body code {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>WebAuthn FIDO2 Test Application</h1>
        <p>Complete testing suite for WebAuthn authentication with simple and advanced options</p>
    </div>

    <div class="container">
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('simple')">Simple Authentication</button>
            <button class="nav-tab" onclick="switchTab('advanced')">Advanced Authentication</button>
            <button class="nav-tab" onclick="switchTab('decoder')">Decoder</button>
        </nav>

        <div class="content">
            <!-- Simple Authentication Tab -->
            <div id="simple-tab" class="tab-content active">
                <div class="section">
                    <h2>Simple Authentication</h2>
                    <p>Basic WebAuthn operations with minimal configuration - same functionality as the original demo.</p>
                    
                    <div class="status" id="simple-status"></div>

                    <div class="form-group">
                        <label for="simple-email">Email (User Identifier)</label>
                        <input type="email" id="simple-email" class="form-control" placeholder="Enter your email">
                    </div>

                    <div class="form-group">
                        <button class="btn" onclick="simpleRegister()">Register Passkey</button>
                        <button class="btn btn-secondary" onclick="simpleAuthenticate()">Authenticate</button>
                    </div>

                    <div class="progress" id="simple-progress">
                        <div class="spinner"></div>
                        <span id="simple-progress-text">Processing...</span>
                    </div>
                </div>
            </div>

            <!-- Advanced Authentication Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="section">
                    <h2>Advanced Authentication</h2>
                    <p>Comprehensive WebAuthn configuration with full control over registration and assertion options.</p>
                    
                    <div class="status" id="advanced-status"></div>

                    <!-- Sub-tabs for Registration and Authentication -->
                    <div class="sub-tabs">
                        <button id="registration-tab-btn" class="sub-tab active" onclick="switchSubTab('registration')">Registration</button>
                        <button id="authentication-tab-btn" class="sub-tab" onclick="switchSubTab('authentication')">Authentication</button>
                    </div>

                    <div class="three-column">
                        <!-- Left Column: Registration/Authentication Form -->
                        <div class="form-column">
                            <h3>Settings</h3>
                            <!-- Registration Form -->
                            <div id="registration-form" class="sub-tab-content active">
                                <!-- User Identity Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('user-identity')">
                                    <span>User Identity</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="user-identity" class="section-content expanded">
                                    <div class="form-group">
                                        <label for="user-id">User ID (hex)</label>
                                        <div class="input-with-button">
                                            <input type="text" id="user-id" class="form-control" placeholder="Auto-generated hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizeUserId()" title="Generate new random User ID"></button>
                                        </div>
                                        <div id="user-id-error" class="error-message">Invalid hex value</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-name">User Name</label>
                                        <input type="text" id="user-name" class="form-control" placeholder="Enter username">
                                    </div>
                                    <div class="form-group">
                                        <label for="user-display-name">Display Name</label>
                                        <input type="text" id="user-display-name" class="form-control" placeholder="Auto-generated from username" readonly style="background-color: #f8f9fa; color: #6c757d;">
                                    </div>
                                </div>
                            </div>

                            <!-- Authenticator Selection Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('authenticator-selection')">
                                    <span>Authenticator Selection</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="authenticator-selection" class="section-content">
                                    <div class="form-group">
                                        <label for="authenticator-attachment">Authenticator Attachment</label>
                                        <select id="authenticator-attachment" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="cross-platform">Cross-platform</option>
                                            <option value="platform">Platform</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="resident-key">Resident Key</label>
                                        <select id="resident-key" class="form-control">
                                            <option value="discouraged">Discouraged (default)</option>
                                            <option value="preferred">Preferred</option>
                                            <option value="required">Required</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-verification-reg">User Verification</label>
                                        <select id="user-verification-reg" class="form-control">
                                            <option value="preferred">Preferred (default)</option>
                                            <option value="discouraged">Discouraged</option>
                                            <option value="required">Required</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="attestation">Attestation</label>
                                        <select id="attestation" class="form-control">
                                            <option value="none">None (default)</option>
                                            <option value="indirect">Indirect</option>
                                            <option value="direct">Direct</option>
                                            <option value="enterprise">Enterprise</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="exclude-credentials" checked> Exclude Credentials
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="fake-cred-length-reg">Fake credential ID length</label>
                                        <input type="number" id="fake-cred-length-reg" class="form-control" value="128" min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Other Options Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('other-options-reg')">
                                    <span>Other Options</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="other-options-reg" class="section-content">
                                    <div class="form-group">
                                        <label for="challenge-reg">Challenge (hex)</label>
                                        <div class="input-with-button">
                                            <input type="text" id="challenge-reg" class="form-control" placeholder="Auto-generated hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizeChallenge('reg')" title="Generate new random challenge"></button>
                                        </div>
                                        <div id="challenge-reg-error" class="error-message">Invalid hex value or less than 16 bytes</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="timeout-reg">Timeout (milliseconds)</label>
                                        <input type="number" id="timeout-reg" class="form-control" value="90000" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Public Key Credential Parameters</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-eddsa" checked>
                                                <label for="param-eddsa">EdDSA</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-es256" checked>
                                                <label for="param-es256">ES256</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs256" checked>
                                                <label for="param-rs256">RS256</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-es384">
                                                <label for="param-es384">ES384</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-es512">
                                                <label for="param-es512">ES512</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs384">
                                                <label for="param-rs384">RS384</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs512">
                                                <label for="param-rs512">RS512</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs1">
                                                <label for="param-rs1">RS1</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Hints</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-client-device">
                                                <label for="hint-client-device">Client-device</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-hybrid">
                                                <label for="hint-hybrid">Hybrid</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-security-key">
                                                <label for="hint-security-key">Security-key</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Extensions Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('extensions-reg')">
                                    <span>Extensions</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="extensions-reg" class="section-content">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="cred-props" checked> credProps
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="min-pin-length"> minPinLength
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="cred-protect">credProtect</label>
                                        <select id="cred-protect" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="userVerificationOptional">userVerificationOptional</option>
                                            <option value="userVerificationOptionalWithCredentialIdList">userVerificationOptionalWithCredentialIdList</option>
                                            <option value="userVerificationRequired">userVerificationRequired</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="enforce-cred-protect" checked disabled> Enforce credProtect
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="large-blob-reg">largeBlob</label>
                                        <select id="large-blob-reg" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="preferred">Preferred</option>
                                            <option value="required">Required</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="prf-reg" checked> prf
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-first-reg">prf eval first</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-first-reg" class="form-control" placeholder="Hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('first', 'reg')" title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-first-reg-error" class="error-message">Invalid hex value</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-second-reg">prf eval second</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-second-reg" class="form-control" placeholder="Hex value" disabled>
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('second', 'reg')" disabled title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-second-reg-error" class="error-message">Invalid hex value</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 2rem;">
                                <button class="btn" onclick="advancedRegister()">Create Credential</button>
                                <button class="btn btn-secondary" onclick="resetRegistrationForm()">Reset</button>
                            </div>
                        </div>

                            <!-- Authentication Form -->
                            <div id="authentication-form" class="sub-tab-content">
                            <!-- Credential Selection Section -->
                            <div class="expandable-section">
                                <div class="section-header expanded" onclick="toggleSection('credential-selection')">
                                    <span>Credential Selection</span>
                                    <span class="expand-icon rotated">▼</span>
                                </div>
                                <div id="credential-selection" class="section-content expanded">
                                    <div class="form-group">
                                        <label for="user-verification-auth">User Verification</label>
                                        <select id="user-verification-auth" class="form-control">
                                            <option value="preferred">Preferred (default)</option>
                                            <option value="discouraged">Discouraged</option>
                                            <option value="required">Required</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="allow-credentials">Allow Credentials</label>
                                        <select id="allow-credentials" class="form-control">
                                            <option value="all">All credentials</option>
                                            <option value="empty">Empty</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="fake-cred-length-auth">Fake credential ID length</label>
                                        <input type="number" id="fake-cred-length-auth" class="form-control" value="256" min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Other Options Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('other-options-auth')">
                                    <span>Other Options</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="other-options-auth" class="section-content">
                                    <div class="form-group">
                                        <label for="challenge-auth">Challenge (hex)</label>
                                        <div class="input-with-button">
                                            <input type="text" id="challenge-auth" class="form-control" placeholder="Auto-generated hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizeChallenge('auth')" title="Generate new random challenge"></button>
                                        </div>
                                        <div id="challenge-auth-error" class="error-message">Invalid hex value or less than 16 bytes</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="timeout-auth">Timeout (milliseconds)</label>
                                        <input type="number" id="timeout-auth" class="form-control" value="90000" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Hints</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-client-device-auth">
                                                <label for="hint-client-device-auth">Client-device</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-hybrid-auth">
                                                <label for="hint-hybrid-auth">Hybrid</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-security-key-auth">
                                                <label for="hint-security-key-auth">Security-key</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Extensions Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('extensions-auth')">
                                    <span>Extensions</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="extensions-auth" class="section-content">
                                    <div class="form-group">
                                        <label for="large-blob-auth">largeBlob</label>
                                        <select id="large-blob-auth" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="read">Read</option>
                                            <option value="write">Write</option>
                                        </select>
                                        <div id="large-blob-capability-message" class="error-message" style="color: #6c757d; display: none;">No largeBlob capable credentials available</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="large-blob-write">largeBlob write</label>
                                        <div class="input-with-button">
                                            <input type="text" id="large-blob-write" class="form-control" placeholder="Hex value" disabled>
                                            <button class="btn btn-small refresh-icon" onclick="randomizeLargeBlobWrite()" disabled title="Generate random large blob data"></button>
                                        </div>
                                        <div id="large-blob-write-error" class="error-message">Invalid hex value</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-first-auth">prf eval first</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-first-auth" class="form-control" placeholder="Hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('first', 'auth')" title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-first-auth-error" class="error-message">Invalid hex value</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-second-auth">prf eval second</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-second-auth" class="form-control" placeholder="Hex value" disabled>
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('second', 'auth')" disabled title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-second-auth-error" class="error-message">Invalid hex value</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 2rem;">
                                <button class="btn" onclick="advancedAuthenticate()">Assert Credential</button>
                                <button class="btn btn-secondary" onclick="resetAuthenticationForm()">Reset</button>
                            </div>
                        </div>
                        </div>

                        <!-- Middle Column: JSON Editor -->
                        <div class="json-editor-column">
                            <h3>JSON Editor</h3>
                            <div id="json-editor-container" class="json-editor">
                                <textarea id="json-editor" placeholder="JSON representation will appear here automatically..."></textarea>
                            </div>
                            <div class="json-editor-buttons" style="margin-top: 0.5rem;">
                                <button class="btn" onclick="saveJsonEditor()" title="Save JSON changes to settings">Save</button>
                                <button class="btn btn-secondary" onclick="resetJsonEditor()" title="Reset JSON to match current settings">Reset</button>
                            </div>
                        </div>

                        <!-- Right Column: Credentials Panel -->
                        <div class="credentials-column">
                            <h3>Saved Credentials</h3>
                            <div class="credentials-panel">
                                <div id="credentials-list">
                                    <p style="color: #6c757d; font-style: italic;">No credentials registered yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress" id="advanced-progress">
                        <div class="spinner"></div>
                        <span id="advanced-progress-text">Processing...</span>
                    </div>
                </div>
            </div>

            <!-- Decoder Tab -->
            <div id="decoder-tab" class="tab-content">
                <div class="section">
                    <h2>WebAuthn Response Decoder</h2>
                    <p>Decode and analyze WebAuthn authentication responses, credential data, and attestation objects.</p>
                    
                    <div class="status" id="decoder-status"></div>

                    <div class="form-group">
                        <label for="decoder-input">Paste WebAuthn Response JSON</label>
                        <textarea id="decoder-input" class="form-control" rows="10" placeholder="Paste your WebAuthn registration or authentication response here..."></textarea>
                    </div>

                    <div class="form-group">
                        <button class="btn" onclick="decodeResponse()">Decode Response</button>
                        <button class="btn btn-secondary" onclick="clearDecoder()">Clear</button>
                    </div>

                    <div id="decoder-output" style="display: none;">
                        <h3>Decoded Information</h3>
                        <div id="decoded-content" class="json-editor">
                            <!-- Decoded output will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import {
            create,
            get,
            parseCreationOptionsFromJSON,
            parseRequestOptionsFromJSON,
        } from '/webauthn-json.browser-ponyfill.js';

        // Make functions globally available
        window.create = create;
        window.get = get;
        window.parseCreationOptionsFromJSON = parseCreationOptionsFromJSON;
        window.parseRequestOptionsFromJSON = parseRequestOptionsFromJSON;
    </script>

    <script>
        let currentSubTab = 'registration';
        let storedCredentials = [];
        let currentJsonMode = null;
        let currentJsonData = null;

        // Utility functions for hex validation and generation
        function isValidHex(str) {
            return /^[0-9a-fA-F]*$/.test(str) && str.length > 0;
        }

        function generateRandomHex(bytes) {
            const array = new Uint8Array(bytes);
            crypto.getRandomValues(array);
            return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Convert hex string to base64url format for WebAuthn JSON
        function hexToBase64Url(hexString) {
            if (!hexString) return '';
            
            // Convert hex to bytes
            const bytes = new Uint8Array(hexString.match(/.{2}/g).map(byte => parseInt(byte, 16)));
            
            // Convert to base64
            const base64 = btoa(String.fromCharCode(...bytes));
            
            // Convert to base64url (URL-safe base64)
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Convert base64url back to hex string
        function base64UrlToHex(base64url) {
            if (!base64url) return '';
            
            // Convert base64url to regular base64
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            
            // Add padding if needed
            while (base64.length % 4) {
                base64 += '=';
            }
            
            // Decode base64 to bytes
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            // Convert bytes to hex
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function validateHexInput(inputId, errorId, minBytes = 0) {
            const input = document.getElementById(inputId);
            const error = document.getElementById(errorId);
            const value = input.value.trim();
            
            if (value && (!isValidHex(value) || value.length < minBytes * 2)) {
                error.style.display = 'block';
                input.classList.add('error');
                return false;
            } else {
                error.style.display = 'none';
                input.classList.remove('error');
                return true;
            }
        }

        // Tab switching functionality
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Update JSON editor if in advanced tab
            if (tab === 'advanced') {
                updateJsonEditor();
            }
        }

        // Sub-tab switching for Registration/Authentication
        function switchSubTab(subTab) {
            currentSubTab = subTab;
            
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(subTab + '-tab-btn').classList.add('active');
            
            // Update sub-tab content
            document.querySelectorAll('.sub-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subTab + '-form').classList.add('active');
            
            // Update JSON editor
            updateJsonEditor();
        }

        // Section toggle functionality
        function toggleSection(sectionId) {
            const header = event.currentTarget;
            const content = document.getElementById(sectionId);
            const icon = header.querySelector('.expand-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
            }
        }

        // Randomization functions
        function randomizeUserId() {
            const userId = generateRandomHex(32);
            document.getElementById('user-id').value = userId;
            updateJsonEditor();
        }

        function randomizeChallenge(type) {
            const challenge = generateRandomHex(16);  // 16 bytes = 32 hex chars
            document.getElementById('challenge-' + type).value = challenge;
            updateJsonEditor();
        }

        function randomizePrfEval(evalType, formType) {
            const prfValue = generateRandomHex(16);  // 16 bytes = 32 hex chars
            document.getElementById('prf-eval-' + evalType + '-' + formType).value = prfValue;
            
            // Enable/disable second PRF eval based on first
            if (evalType === 'first') {
                const secondInput = document.getElementById('prf-eval-second-' + formType);
                const secondButton = secondInput.nextElementSibling;
                if (prfValue) {
                    secondInput.disabled = false;
                    secondButton.disabled = false;
                } else {
                    secondInput.disabled = true;
                    secondButton.disabled = true;
                    secondInput.value = '';
                }
            }
            
            updateJsonEditor();
        }

        function validatePrfInputs(formType) {
            const firstInput = document.getElementById('prf-eval-first-' + formType);
            const secondInput = document.getElementById('prf-eval-second-' + formType);
            const secondButton = secondInput.nextElementSibling;
            
            if (firstInput.value.trim() === '') {
                secondInput.disabled = true;
                secondButton.disabled = true;
                secondInput.value = '';
            } else {
                secondInput.disabled = false;
                secondButton.disabled = false;
            }
            
            updateJsonEditor();
        }

        // Input validation functions
        function validateHexInput(input, minLength = 16, maxLength = 128) {
            const value = input.value.trim();
            const errorElement = document.getElementById(input.id + '-error');
            
            if (value === '') {
                errorElement.style.display = 'none';
                input.classList.remove('error');
                return true;
            }
            
            const hexPattern = /^[0-9a-fA-F]+$/;
            if (!hexPattern.test(value) || value.length < minLength || value.length > maxLength) {
                errorElement.style.display = 'block';
                input.classList.add('error');
                return false;
            } else {
                errorElement.style.display = 'none';
                input.classList.remove('error');
                return true;
            }
        }

        function validateUserIdInput() {
            const userIdInput = document.getElementById('user-id');
            return validateHexInput(userIdInput, 16, 64);
        }

        function validateChallengeInputs() {
            const challengeRegInput = document.getElementById('challenge-reg');
            const challengeAuthInput = document.getElementById('challenge-auth');
            
            let valid = true;
            if (challengeRegInput) valid &= validateHexInput(challengeRegInput, 32, 64);
            if (challengeAuthInput) valid &= validateHexInput(challengeAuthInput, 32, 64);
            
            return valid;
        }

        function validatePrfEvalInputs() {
            const prfInputs = [
                'prf-eval-first-reg', 
                'prf-eval-second-reg',
                'prf-eval-first-auth', 
                'prf-eval-second-auth'
            ];
            
            let valid = true;
            prfInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && !input.disabled) {
                    valid &= validateHexInput(input, 32, 64);
                }
            });
            
            return valid;
        }

        function validateLargeBlobWriteInput() {
            const largeBlobWriteInput = document.getElementById('large-blob-write');
            if (!largeBlobWriteInput || largeBlobWriteInput.disabled) {
                return true; // If disabled or not found, consider it valid
            }
            
            return validateHexInput(largeBlobWriteInput, 2, 2048); // At least 1 byte, max 1024 bytes (2048 hex chars)
        }

        function checkLargeBlobCapability() {
            // Check if any saved credentials support large blob
            let hasLargeBlobCapability = false;
            
            // For now, we'll assume that credentials created with largeBlob support in registration 
            // would have this capability. In a real implementation, you'd check the credential data.
            // Since we don't have this info readily available, we'll enable it if there are any credentials
            // and assume they might support it. A more robust implementation would check the actual 
            // credential metadata.
            hasLargeBlobCapability = storedCredentials.length > 0;
            
            const largeBlobSelect = document.getElementById('large-blob-auth');
            const largeBlobWriteInput = document.getElementById('large-blob-write');
            const largeBlobWriteButton = largeBlobWriteInput?.nextElementSibling;
            const messageElement = document.getElementById('large-blob-capability-message');
            const readOption = largeBlobSelect?.querySelector('option[value="read"]');
            const writeOption = largeBlobSelect?.querySelector('option[value="write"]');
            
            if (hasLargeBlobCapability) {
                // Enable largeBlob read/write options
                if (readOption) readOption.disabled = false;
                if (writeOption) writeOption.disabled = false;
                if (messageElement) messageElement.style.display = 'none';
                
                // Enable/disable write input based on selection
                const currentValue = largeBlobSelect?.value;
                if (largeBlobWriteInput && largeBlobWriteButton) {
                    if (currentValue === 'write') {
                        largeBlobWriteInput.disabled = false;
                        largeBlobWriteButton.disabled = false;
                    } else {
                        largeBlobWriteInput.disabled = true;
                        largeBlobWriteButton.disabled = true;
                    }
                }
            } else {
                // Disable largeBlob read/write options
                if (readOption) readOption.disabled = true;
                if (writeOption) writeOption.disabled = true;
                if (largeBlobWriteInput) largeBlobWriteInput.disabled = true;
                if (largeBlobWriteButton) largeBlobWriteButton.disabled = true;
                if (messageElement) messageElement.style.display = 'block';
                
                // Reset selection to default
                if (largeBlobSelect) largeBlobSelect.value = '';
            }
        }

        // Auto-detect and load PKL credentials
        async function loadSavedCredentials() {
            try {
                const response = await fetch('/api/credentials', {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'}
                });

                if (response.ok) {
                    const credentials = await response.json();
                    storedCredentials = credentials;
                    updateCredentialsDisplay();
                    updateJsonEditor(); // Update JSON editor in case allowCredentials needs updating
                } else {
                    console.warn('Failed to load saved credentials');
                }
            } catch (error) {
                console.error('Error loading saved credentials:', error);
            }
        }

        function updateCredentialsDisplay() {
            const credentialsList = document.getElementById('credentials-list');
            
            if (storedCredentials.length === 0) {
                credentialsList.innerHTML = '<p style="color: #6c757d; font-style: italic;">No credentials registered yet.</p>';
                checkLargeBlobCapability(); // Check capability when no credentials
                return;
            }

            credentialsList.innerHTML = storedCredentials.map((cred, index) => `
                <div class="credential-item" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; color: #495057; font-size: 0.9rem; margin-bottom: 0.25rem;">${cred.email || cred.username || 'Unknown User'}</div>
                        <div style="font-size: 0.75rem; color: #6c757d;">
                            ${cred.algorithm || 'Unknown'} • ${cred.createdAt ? new Date(cred.createdAt).toLocaleDateString() : 'Unknown date'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                        <button class="btn-small" onclick="showCredentialDetails(${index})" style="background: #325F74; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Details</button>
                        <button class="btn-small btn-danger" onclick="deleteCredential('${cred.email || cred.username}', ${index})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Delete</button>
                    </div>
                </div>
            `).join('');
            
            // Check large blob capability after updating display
            checkLargeBlobCapability();
        }

        function showCredentialDetails(index) {
            const cred = storedCredentials[index];
            if (!cred) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <p><strong>Username:</strong> ${cred.email || cred.username || 'N/A'}</p>
                <p><strong>Display Name:</strong> ${cred.displayName || cred.userName || cred.email || cred.username || 'N/A'}</p>
                <p><strong>Credential ID:</strong><br><code>${cred.credentialId || 'Unknown'}</code></p>
                <p><strong>Algorithm:</strong> ${cred.algorithm || 'Unknown'}</p>
                <p><strong>Type:</strong> ${cred.type || 'WebAuthn'}</p>
                <p><strong>Sign Count:</strong> ${cred.signCount || 0}</p>
                <p><strong>Created:</strong> ${cred.createdAt ? new Date(cred.createdAt).toLocaleString() : 'Unknown'}</p>
            `;

            document.getElementById('credentialModal').style.display = 'block';
        }

        function closeCredentialModal() {
            document.getElementById('credentialModal').style.display = 'none';
        }

        async function deleteCredential(username, index) {
            if (!confirm(`Are you sure you want to delete the credential for ${username}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/deletepub', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"email": username})
                });

                if (response.ok) {
                    // Remove from local array
                    storedCredentials.splice(index, 1);
                    updateCredentialsDisplay();
                    showStatus('advanced', 'Credential deleted successfully!', 'success');
                } else {
                    throw new Error('Failed to delete credential from server');
                }
            } catch (error) {
                console.error('Error deleting credential:', error);
                showStatus('advanced', `Failed to delete credential: ${error.message}`, 'error');
            }
        }

        function randomizeLargeBlobWrite() {
            const blobValue = generateRandomHex(16);  // 16 bytes = 32 hex chars
            document.getElementById('large-blob-write').value = blobValue;
            updateJsonEditor();
        }

        // Reset functions
        function resetRegistrationForm() {
            // Reset User Identity
            document.getElementById('user-id').value = generateRandomHex(32);
            document.getElementById('user-name').value = '';
            document.getElementById('user-display-name').value = '';
            
            // Reset Authenticator Selection
            document.getElementById('authenticator-attachment').value = '';
            document.getElementById('resident-key').value = 'discouraged';
            document.getElementById('user-verification-reg').value = 'preferred';
            document.getElementById('attestation').value = 'none';
            document.getElementById('exclude-credentials').checked = true;
            document.getElementById('fake-cred-length-reg').value = '128';
            
            // Reset Other Options
            document.getElementById('challenge-reg').value = generateRandomHex(16);  // 16 bytes = 32 hex chars
            document.getElementById('timeout-reg').value = '90000';
            document.getElementById('param-eddsa').checked = true;
            document.getElementById('param-es256').checked = true;
            document.getElementById('param-rs256').checked = true;
            document.getElementById('param-es384').checked = false;
            document.getElementById('param-es512').checked = false;
            document.getElementById('param-rs384').checked = false;
            document.getElementById('param-rs512').checked = false;
            document.getElementById('param-rs1').checked = false;
            document.getElementById('hint-client-device').checked = false;
            document.getElementById('hint-hybrid').checked = false;
            document.getElementById('hint-security-key').checked = false;
            
            // Reset Extensions
            document.getElementById('cred-props').checked = true;
            document.getElementById('min-pin-length').checked = false;
            document.getElementById('cred-protect').value = '';
            document.getElementById('enforce-cred-protect').checked = true;
            document.getElementById('enforce-cred-protect').disabled = true;
            document.getElementById('large-blob-reg').value = '';
            document.getElementById('prf-reg').checked = true;
            document.getElementById('prf-eval-first-reg').value = '';
            document.getElementById('prf-eval-second-reg').value = '';
            document.getElementById('prf-eval-second-reg').disabled = true;
            
            updateJsonEditor();
        }

        function resetAuthenticationForm() {
            // Reset Credential Selection
            document.getElementById('user-verification-auth').value = 'preferred';
            document.getElementById('allow-credentials').value = 'all';
            document.getElementById('fake-cred-length-auth').value = '256';
            
            // Reset Other Options
            document.getElementById('challenge-auth').value = generateRandomHex(16);  // 16 bytes = 32 hex chars
            document.getElementById('timeout-auth').value = '90000';
            document.getElementById('hint-client-device-auth').checked = false;
            document.getElementById('hint-hybrid-auth').checked = false;
            document.getElementById('hint-security-key-auth').checked = false;
            
            // Reset Extensions
            document.getElementById('large-blob-auth').value = '';
            document.getElementById('large-blob-write').value = '';
            document.getElementById('large-blob-write').disabled = true;
            document.getElementById('prf-eval-first-auth').value = '';
            document.getElementById('prf-eval-second-auth').value = '';
            document.getElementById('prf-eval-second-auth').disabled = true;
            
            updateJsonEditor();
        }

        // JSON Editor update function
        function updateJsonEditor() {
            let options = {};
            let title = 'JSON Editor';
            
            if (currentSubTab === 'registration') {
                options = getCredentialCreationOptions();
                title = 'JSON Editor (CredentialCreationOptions)';
            } else if (currentSubTab === 'authentication') {
                options = getCredentialRequestOptions();
                title = 'JSON Editor (CredentialRequestOptions)';
            }
            
            const jsonEditor = document.getElementById('json-editor');
            if (jsonEditor) {
                jsonEditor.value = JSON.stringify(options, null, 2);
            }
            
            // Update the title
            const titleElement = document.querySelector('.json-editor-column h3');
            if (titleElement) {
                titleElement.textContent = title;
            }
        }

        // Save JSON Editor changes to settings
        function saveJsonEditor() {
            try {
                const jsonText = document.getElementById('json-editor').value;
                const parsed = JSON.parse(jsonText);
                
                // Validate the structure
                if (!parsed.publicKey) {
                    throw new Error('Invalid JSON structure: Missing "publicKey" property');
                }
                
                const publicKey = parsed.publicKey;
                
                if (currentSubTab === 'registration') {
                    // Validate CredentialCreationOptions structure
                    if (!publicKey.rp || !publicKey.user || !publicKey.challenge) {
                        throw new Error('Invalid CredentialCreationOptions: Missing required properties (rp, user, challenge)');
                    }
                    
                    // Update form fields from JSON
                    updateRegistrationFormFromJson(publicKey);
                } else if (currentSubTab === 'authentication') {
                    // Validate CredentialRequestOptions structure
                    if (!publicKey.challenge) {
                        throw new Error('Invalid CredentialRequestOptions: Missing required challenge property');
                    }
                    
                    // Update form fields from JSON
                    updateAuthenticationFormFromJson(publicKey);
                }
                
                // Show success message
                const statusDiv = document.querySelector('#advanced-tab .status') || 
                                document.querySelector('#advanced-status');
                if (statusDiv) {
                    statusDiv.textContent = 'JSON changes saved successfully!';
                    statusDiv.className = 'status success';
                    statusDiv.style.display = 'block';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
                
            } catch (error) {
                // Show error message
                const statusDiv = document.querySelector('#advanced-tab .status') || 
                                document.querySelector('#advanced-status');
                if (statusDiv) {
                    statusDiv.textContent = `JSON validation failed: ${error.message}`;
                    statusDiv.className = 'status error';
                    statusDiv.style.display = 'block';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Reset JSON Editor to match current settings
        function resetJsonEditor() {
            updateJsonEditor();
            
            // Show reset confirmation
            const statusDiv = document.querySelector('#advanced-tab .status') || 
                            document.querySelector('#advanced-status');
            if (statusDiv) {
                statusDiv.textContent = 'JSON editor reset to current settings';
                statusDiv.className = 'status info';
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 2000);
            }
        }

        // Update registration form fields from JSON
        function updateRegistrationFormFromJson(publicKey) {
            // Update user fields
            if (publicKey.user) {
                if (publicKey.user.id && publicKey.user.id.$base64) {
                    document.getElementById('user-id').value = base64UrlToHex(publicKey.user.id.$base64);
                }
                if (publicKey.user.name) {
                    document.getElementById('user-name').value = publicKey.user.name;
                }
                if (publicKey.user.displayName) {
                    document.getElementById('user-display-name').value = publicKey.user.displayName;
                }
            }
            
            // Update challenge
            if (publicKey.challenge && publicKey.challenge.$base64) {
                document.getElementById('challenge-reg').value = base64UrlToHex(publicKey.challenge.$base64);
            }
            
            // Update timeout
            if (publicKey.timeout) {
                document.getElementById('timeout-reg').value = publicKey.timeout.toString();
            }
            
            // Update attestation
            if (publicKey.attestation) {
                document.getElementById('attestation').value = publicKey.attestation;
            }
            
            // Update authenticator selection
            if (publicKey.authenticatorSelection) {
                if (publicKey.authenticatorSelection.authenticatorAttachment) {
                    document.getElementById('authenticator-attachment').value = publicKey.authenticatorSelection.authenticatorAttachment;
                }
                if (publicKey.authenticatorSelection.residentKey) {
                    document.getElementById('resident-key').value = publicKey.authenticatorSelection.residentKey;
                }
                if (publicKey.authenticatorSelection.userVerification) {
                    document.getElementById('user-verification-reg').value = publicKey.authenticatorSelection.userVerification;
                }
            }
            
            // Update extensions
            if (publicKey.extensions) {
                if (publicKey.extensions.prf && publicKey.extensions.prf.eval) {
                    if (publicKey.extensions.prf.eval.first && publicKey.extensions.prf.eval.first.$base64) {
                        document.getElementById('prf-eval-first-reg').value = base64UrlToHex(publicKey.extensions.prf.eval.first.$base64);
                    }
                    if (publicKey.extensions.prf.eval.second && publicKey.extensions.prf.eval.second.$base64) {
                        document.getElementById('prf-eval-second-reg').value = base64UrlToHex(publicKey.extensions.prf.eval.second.$base64);
                    }
                }
            }
        }

        // Update authentication form fields from JSON
        function updateAuthenticationFormFromJson(publicKey) {
            // Update challenge
            if (publicKey.challenge && publicKey.challenge.$base64) {
                document.getElementById('challenge-auth').value = base64UrlToHex(publicKey.challenge.$base64);
            }
            
            // Update timeout
            if (publicKey.timeout) {
                document.getElementById('timeout-auth').value = publicKey.timeout.toString();
            }
            
            // Update user verification
            if (publicKey.userVerification) {
                document.getElementById('user-verification-auth').value = publicKey.userVerification;
            }
            
            // Update extensions
            if (publicKey.extensions) {
                if (publicKey.extensions.prf && publicKey.extensions.prf.eval) {
                    if (publicKey.extensions.prf.eval.first && publicKey.extensions.prf.eval.first.$base64) {
                        document.getElementById('prf-eval-first-auth').value = base64UrlToHex(publicKey.extensions.prf.eval.first.$base64);
                    }
                    if (publicKey.extensions.prf.eval.second && publicKey.extensions.prf.eval.second.$base64) {
                        document.getElementById('prf-eval-second-auth').value = base64UrlToHex(publicKey.extensions.prf.eval.second.$base64);
                    }
                }
                
                if (publicKey.extensions.largeBlob) {
                    if (publicKey.extensions.largeBlob.read) {
                        document.getElementById('large-blob-auth').value = 'read';
                    } else if (publicKey.extensions.largeBlob.write) {
                        document.getElementById('large-blob-auth').value = 'write';
                        if (publicKey.extensions.largeBlob.write.$base64) {
                            document.getElementById('large-blob-write').value = base64UrlToHex(publicKey.extensions.largeBlob.write.$base64);
                        }
                    }
                }
            }
        }

        // Get CredentialCreationOptions from form (WebAuthn standard format)
        function getCredentialCreationOptions() {
            const userId = document.getElementById('user-id')?.value || generateRandomHex(32);
            const userName = document.getElementById('user-name')?.value || 'testuser';
            const userDisplayName = document.getElementById('user-display-name')?.value || 'Test User';
            const challenge = document.getElementById('challenge-reg')?.value || generateRandomHex(16);
            
            // Build publicKey object
            const publicKey = {
                rp: {
                    name: "WebAuthn FIDO2 Test Application",
                    id: window.location.hostname
                },
                user: {
                    id: {
                        "$base64": hexToBase64Url(userId)
                    },
                    name: userName,
                    displayName: userDisplayName
                },
                challenge: {
                    "$base64": hexToBase64Url(challenge)
                },
                pubKeyCredParams: [],
                timeout: parseInt(document.getElementById('timeout-reg')?.value) || 90000,
                authenticatorSelection: {},
                attestation: document.getElementById('attestation')?.value || 'none',
                extensions: {}
            };

            // Add selected algorithms
            if (document.getElementById('param-eddsa')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -8}); // EdDSA
            }
            if (document.getElementById('param-es256')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -7}); // ES256
            }
            if (document.getElementById('param-rs256')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -257}); // RS256
            }
            if (document.getElementById('param-es384')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -35}); // ES384
            }
            if (document.getElementById('param-es512')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -36}); // ES512
            }
            if (document.getElementById('param-rs384')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -258}); // RS384
            }
            if (document.getElementById('param-rs512')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -259}); // RS512
            }
            if (document.getElementById('param-rs1')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -65535}); // RS1
            }

            // Authenticator selection
            const authAttachment = document.getElementById('authenticator-attachment')?.value;
            if (authAttachment) publicKey.authenticatorSelection.authenticatorAttachment = authAttachment;
            
            const residentKey = document.getElementById('resident-key')?.value;
            if (residentKey && residentKey !== 'discouraged') publicKey.authenticatorSelection.residentKey = residentKey;
            
            const userVerification = document.getElementById('user-verification-reg')?.value;
            if (userVerification) publicKey.authenticatorSelection.userVerification = userVerification;

            // Exclude credentials
            if (document.getElementById('exclude-credentials')?.checked && storedCredentials.length > 0) {
                publicKey.excludeCredentials = storedCredentials.map(cred => ({
                    type: "public-key",
                    id: {
                        "$base64": hexToBase64Url(cred.credentialId)
                    }
                }));
            }

            // Extensions
            if (document.getElementById('cred-props')?.checked) publicKey.extensions.credProps = true;
            if (document.getElementById('min-pin-length')?.checked) publicKey.extensions.minPinLength = true;
            
            const credProtect = document.getElementById('cred-protect')?.value;
            if (credProtect) {
                publicKey.extensions.credProtect = credProtect;
                if (document.getElementById('enforce-cred-protect')?.checked) {
                    publicKey.extensions.enforceCredProtect = true;
                }
            }
            
            const largeBlobReg = document.getElementById('large-blob-reg')?.value;
            if (largeBlobReg) publicKey.extensions.largeBlob = {support: largeBlobReg};
            
            if (document.getElementById('prf-reg')?.checked) {
                const prfFirst = document.getElementById('prf-eval-first-reg')?.value;
                const prfSecond = document.getElementById('prf-eval-second-reg')?.value;
                if (prfFirst) {
                    publicKey.extensions.prf = {
                        eval: {
                            first: {
                                "$base64": hexToBase64Url(prfFirst)
                            }
                        }
                    };
                    if (prfSecond) {
                        publicKey.extensions.prf.eval.second = {
                            "$base64": hexToBase64Url(prfSecond)
                        };
                    }
                }
            }

            // Add hints if any are selected
            const hints = [];
            if (document.getElementById('hint-client-device')?.checked) hints.push('client-device');
            if (document.getElementById('hint-hybrid')?.checked) hints.push('hybrid');
            if (document.getElementById('hint-security-key')?.checked) hints.push('security-key');
            if (hints.length > 0) publicKey.hints = hints;

            return { publicKey };
        }

        // Get CredentialRequestOptions from form (WebAuthn standard format)
        function getCredentialRequestOptions() {
            const challenge = document.getElementById('challenge-auth')?.value || generateRandomHex(16);
            
            // Build publicKey object  
            const publicKey = {
                challenge: {
                    "$base64": hexToBase64Url(challenge)
                },
                timeout: parseInt(document.getElementById('timeout-auth')?.value) || 90000,
                rpId: window.location.hostname,
                allowCredentials: [],
                userVerification: document.getElementById('user-verification-auth')?.value || 'preferred',
                extensions: {}
            };

            // Allow credentials handling
            const allowCreds = document.getElementById('allow-credentials')?.value;
            if (allowCreds === 'empty') {
                publicKey.allowCredentials = [];
            } else {
                // For real implementation, this would be populated with actual credential IDs
                publicKey.allowCredentials = storedCredentials.map(cred => ({
                    type: "public-key",
                    id: {
                        "$base64": hexToBase64Url(cred.credentialId)
                    }
                }));
            }

            // Extensions
            const largeBlobAuth = document.getElementById('large-blob-auth')?.value;
            if (largeBlobAuth) {
                if (largeBlobAuth === 'read') {
                    publicKey.extensions.largeBlob = {read: true};
                } else if (largeBlobAuth === 'write') {
                    const largeBlobWrite = document.getElementById('large-blob-write')?.value;
                    if (largeBlobWrite) {
                        publicKey.extensions.largeBlob = {
                            write: {
                                "$base64": hexToBase64Url(largeBlobWrite)
                            }
                        };
                    }
                }
            }
            
            const prfFirst = document.getElementById('prf-eval-first-auth')?.value;
            const prfSecond = document.getElementById('prf-eval-second-auth')?.value;
            if (prfFirst) {
                publicKey.extensions.prf = {
                    eval: {
                        first: {
                            "$base64": hexToBase64Url(prfFirst)
                        }
                    }
                };
                if (prfSecond) {
                    publicKey.extensions.prf.eval.second = {
                        "$base64": hexToBase64Url(prfSecond)
                    };
                }
            }

            // Add hints if any are selected
            const hints = [];
            if (document.getElementById('hint-client-device-auth')?.checked) hints.push('client-device');
            if (document.getElementById('hint-hybrid-auth')?.checked) hints.push('hybrid');  
            if (document.getElementById('hint-security-key-auth')?.checked) hints.push('security-key');
            if (hints.length > 0) publicKey.hints = hints;

            return { publicKey };
        }

        // Utility functions
        function showStatus(tabId, message, type) {
            const statusEl = document.getElementById(tabId + '-status');
            statusEl.className = 'status ' + type;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                hideStatus(tabId);
            }, 5000);
        }

        function hideStatus(tabId) {
            document.getElementById(tabId + '-status').style.display = 'none';
        }

        function showProgress(tabId, message) {
            const progressEl = document.getElementById(tabId + '-progress');
            const textEl = document.getElementById(tabId + '-progress-text');
            textEl.textContent = message;
            progressEl.classList.add('show');
        }

        function hideProgress(tabId) {
            document.getElementById(tabId + '-progress').classList.remove('show');
        }

        // Simple authentication functions (keeping existing functionality)
        async function simpleRegister() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting registration...');

                const response = await fetch('/api/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email}),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                const createOptions = parseCreationOptionsFromJSON(json);

                showProgress('simple', 'Touch your authenticator device...');

                const credential = await create(createOptions);
                
                showProgress('simple', 'Completing registration...');

                const result = await fetch('/api/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        response: credential
                    }),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('simple', `Registration successful! Algorithm: ${data.algo || 'Unknown'}`, 'success');
                    
                    // Add to credentials list
                    addCredentialToList({
                        type: 'simple',
                        email: email,
                        credentialId: credential.id,
                        algorithm: data.algo || 'Unknown'
                    });
                } else {
                    throw new Error('Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showStatus('simple', `Registration failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        async function simpleAuthenticate() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting authentication...');

                const response = await fetch('/api/authenticate/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email}),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                const getOptions = parseRequestOptionsFromJSON(json);

                showProgress('simple', 'Touch your authenticator device...');

                const assertion = await get(getOptions);
                
                showProgress('simple', 'Completing authentication...');

                const result = await fetch('/api/authenticate/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        response: assertion
                    }),
                });

                if (result.ok) {
                    showStatus('simple', 'Authentication successful!', 'success');
                } else {
                    throw new Error('Authentication failed');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showStatus('simple', `Authentication failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        // Credentials management
        function addCredentialToList(credential) {
            storedCredentials.push(credential);
            updateCredentialsList();
        }

        function updateCredentialsList() {
            const list = document.getElementById('credentials-list');
            
            if (storedCredentials.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; font-style: italic;">No credentials registered yet.</p>';
                return;
            }

            list.innerHTML = '';
            storedCredentials.forEach((cred, index) => {
                const credItem = document.createElement('div');
                credItem.className = 'credential-item';
                credItem.onclick = () => toggleCredentialDetails(index);
                
                let summary = '';
                if (cred.type === 'simple') {
                    summary = cred.email || cred.username;
                } else {
                    summary = `${cred.userName || cred.userId}`;
                    if (cred.displayName) summary += `\n${cred.displayName}`;
                }
                
                credItem.innerHTML = `
                    <div class="credential-summary">${summary}</div>
                    <div class="credential-details">
                        ${generateCredentialDetails(cred)}
                        <button class="credential-delete" onclick="deleteCredential(${index}); event.stopPropagation();">Delete</button>
                    </div>
                `;
                
                list.appendChild(credItem);
            });
        }

        function generateCredentialDetails(cred) {
            if (cred.type === 'simple') {
                return `
                    <strong>Type:</strong> Simple Authentication<br>
                    <strong>User:</strong> ${cred.email || cred.username}<br>
                    <strong>Credential ID:</strong> ${cred.credentialId}<br>
                    <strong>Algorithm:</strong> ${cred.algorithm}
                `;
            } else {
                return `
                    <strong>Type:</strong> Advanced Authentication<br>
                    <strong>User ID:</strong> ${cred.userId}<br>
                    <strong>User Name:</strong> ${cred.userName}<br>
                    <strong>Display Name:</strong> ${cred.displayName || 'N/A'}<br>
                    <strong>Credential ID:</strong> ${cred.credentialId}<br>
                    <strong>Algorithm:</strong> ${cred.algorithm}
                `;
            }
        }

        function toggleCredentialDetails(index) {
            const credItems = document.querySelectorAll('.credential-item');
            const item = credItems[index];
            
            if (item.classList.contains('expanded')) {
                item.classList.remove('expanded');
            } else {
                // Close all others
                credItems.forEach(item => item.classList.remove('expanded'));
                // Open this one
                item.classList.add('expanded');
            }
        }





        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with random values
            setTimeout(() => {
                randomizeUserId();
                randomizeChallenge('reg');
                randomizeChallenge('auth');
                // Auto-generate large blob write value on page load
                randomizeLargeBlobWrite();
                // Load saved credentials
                loadSavedCredentials();
            }, 100);
            
            // Set up form field listeners for auto-sync
            setTimeout(() => {
                const allInputs = document.querySelectorAll('#advanced-tab input, #advanced-tab select, #advanced-tab input[type="checkbox"]');
                allInputs.forEach(input => {
                    input.addEventListener('input', updateJsonEditor);
                    input.addEventListener('change', updateJsonEditor);
                });

                // Set up display name sync with username
                const usernameInput = document.getElementById('user-name');
                const displayNameInput = document.getElementById('user-display-name');
                if (usernameInput && displayNameInput) {
                    usernameInput.addEventListener('input', () => {
                        displayNameInput.value = usernameInput.value;
                        updateJsonEditor();
                    });
                }

                // Set up large blob select listener
                const largeBlobSelect = document.getElementById('large-blob-auth');
                if (largeBlobSelect) {
                    largeBlobSelect.addEventListener('change', () => {
                        checkLargeBlobCapability(); // Re-check to enable/disable write input
                        updateJsonEditor();
                    });
                }

                // Set up modal close on outside click
                const modal = document.getElementById('credentialModal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeCredentialModal();
                        }
                    });
                }
                
                // Set up specific PRF validation listeners
                const prfFirstInputs = ['prf-eval-first-reg', 'prf-eval-first-auth'];
                prfFirstInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            const formType = inputId.includes('reg') ? 'reg' : 'auth';
                            validatePrfInputs(formType);
                            validatePrfEvalInputs();
                        });
                        input.addEventListener('change', () => {
                            const formType = inputId.includes('reg') ? 'reg' : 'auth';
                            validatePrfInputs(formType);
                            validatePrfEvalInputs();
                        });
                    }
                });

                // Set up validation listeners for hex inputs
                const hexInputs = [
                    'user-id', 'challenge-reg', 'challenge-auth',
                    'prf-eval-first-reg', 'prf-eval-second-reg',
                    'prf-eval-first-auth', 'prf-eval-second-auth',
                    'large-blob-write'
                ];
                hexInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            if (inputId === 'user-id') validateUserIdInput();
                            else if (inputId.includes('challenge')) validateChallengeInputs();
                            else if (inputId.includes('prf-eval')) validatePrfEvalInputs();
                            else if (inputId === 'large-blob-write') validateLargeBlobWriteInput();
                        });
                        input.addEventListener('blur', () => {
                            if (inputId === 'user-id') validateUserIdInput();
                            else if (inputId.includes('challenge')) validateChallengeInputs();
                            else if (inputId.includes('prf-eval')) validatePrfEvalInputs();
                            else if (inputId === 'large-blob-write') validateLargeBlobWriteInput();
                        });
                    }
                });
            }, 100);
            
            // Initialize JSON editor
            setTimeout(updateJsonEditor, 200);
            
            // Load saved credentials
            setTimeout(loadSavedCredentials, 300);
        });

        // Make functions globally available
        window.switchTab = switchTab;
        window.switchSubTab = switchSubTab;
        window.toggleSection = toggleSection;
        window.randomizeUserId = randomizeUserId;
        window.randomizeChallenge = randomizeChallenge;
        window.randomizePrfEval = randomizePrfEval;
        window.randomizeLargeBlobWrite = randomizeLargeBlobWrite;
        window.resetRegistrationForm = resetRegistrationForm;
        window.resetAuthenticationForm = resetAuthenticationForm;
        window.simpleRegister = simpleRegister;
        window.simpleAuthenticate = simpleAuthenticate;
        window.advancedRegister = advancedRegister;
        window.advancedAuthenticate = advancedAuthenticate;
        window.decodeResponse = decodeResponse;
        window.clearDecoder = clearDecoder;

        function showProgress(tabId, message) {
            const progressEl = document.getElementById(tabId + '-progress');
            const textEl = document.getElementById(tabId + '-progress-text');
            textEl.textContent = message;
            progressEl.classList.add('show');
        }

        function hideProgress(tabId) {
            document.getElementById(tabId + '-progress').classList.remove('show');
        }

        // Simple Authentication Functions
        async function simpleRegister() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting registration...');

                const request = await fetch(`/api/register/begin?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                });

                if (!request.ok) {
                    throw new Error(`HTTP ${request.status}: ${request.statusText}`);
                }

                const json = await request.json();
                const options = parseCreationOptionsFromJSON(json);
                
                showProgress('simple', 'Touch your authenticator device...');

                const response = await create(options);
                
                showProgress('simple', 'Completing registration...');

                const result = await fetch(`/api/register/complete?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(response),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('simple', `Registration successful! Algorithm used: ${data.algo}`, 'success');
                } else {
                    throw new Error('Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showStatus('simple', `Registration failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        async function simpleAuthenticate() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting authentication...');

                const request = await fetch(`/api/authenticate/begin?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                });

                if (!request.ok) {
                    if (request.status === 404) {
                        throw new Error('No credentials found for this email. Please register first.');
                    }
                    throw new Error(`HTTP ${request.status}: ${request.statusText}`);
                }

                const json = await request.json();
                const options = parseRequestOptionsFromJSON(json);
                
                showProgress('simple', 'Touch your authenticator device...');

                const response = await get(options);
                
                showProgress('simple', 'Completing authentication...');

                const result = await fetch(`/api/authenticate/complete?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(response),
                });

                if (result.ok) {
                    showStatus('simple', 'Authentication successful!', 'success');
                } else {
                    throw new Error('Authentication failed');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showStatus('simple', `Authentication failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        async function simpleDelete() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete all credentials for ${email}?`)) {
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Deleting credentials...');

                const result = await fetch('/api/deletepub', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"email": email}),
                });

                if (result.ok) {
                    showStatus('simple', 'Credentials deleted successfully!', 'success');
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                console.error('Deletion error:', error);
                showStatus('simple', `Deletion failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        // Advanced Authentication Functions
        function getAdvancedCreateOptions() {
            return {
                username: document.getElementById('user-name').value,
                displayName: document.getElementById('user-display-name').value || document.getElementById('user-name').value,
                attestation: document.getElementById('attestation').value,
                userVerification: document.getElementById('user-verification-reg').value,
                authenticatorAttachment: document.getElementById('authenticator-attachment').value || undefined,
                residentKey: document.getElementById('resident-key').value
            };
        }

        function getAdvancedAssertOptions() {
            return {
                userVerification: document.getElementById('user-verification-auth').value
            };
        }

        async function advancedRegister() {
            // Validate all inputs first
            const isUserIdValid = validateUserIdInput();
            const isChallengeValid = validateChallengeInputs();
            const isPrfValid = validatePrfEvalInputs();
            const isLargeBlobValid = validateLargeBlobWriteInput();
            
            if (!isUserIdValid || !isChallengeValid || !isPrfValid || !isLargeBlobValid) {
                showStatus('advanced', 'Please fix the validation errors above', 'error');
                return;
            }

            const options = getAdvancedCreateOptions();
            if (!options.username) {
                showStatus('advanced', 'Please enter a username', 'error');
                return;
            }

            try {
                hideStatus('advanced');
                showProgress('advanced', 'Starting advanced registration...');

                const response = await fetch('/api/advanced/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(options)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }

                const json = await response.json();
                const createOptions = parseCreationOptionsFromJSON(json);
                
                showProgress('advanced', 'Touch your authenticator device...');

                const credential = await create(createOptions);
                
                showProgress('advanced', 'Completing registration...');

                const result = await fetch('/api/advanced/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ...options,
                        response: credential
                    }),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('advanced', `Advanced registration successful! Algorithm: ${data.algo || 'Unknown'}`, 'success');
                    
                    // Reload credentials from server to get the latest
                    setTimeout(loadSavedCredentials, 1000);
                } else {
                    const errorText = await result.text();
                    throw new Error(`Registration failed: ${errorText}`);
                }
            } catch (error) {
                console.error('Advanced registration error:', error);
                
                let errorMessage = error.message;
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'User cancelled or authenticator not available';
                } else if (error.name === 'InvalidStateError') {
                    errorMessage = 'Authenticator is already registered for this account';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Security error - check your connection and try again';
                }
                
                showStatus('advanced', `Advanced registration failed: ${errorMessage}`, 'error');
            } finally {
                hideProgress('advanced');
            }
        }

        async function advancedAuthenticate() {
            // Validate all inputs first
            const isChallengeValid = validateChallengeInputs();
            const isPrfValid = validatePrfEvalInputs();
            const isLargeBlobValid = validateLargeBlobWriteInput();
            
            if (!isChallengeValid || !isPrfValid || !isLargeBlobValid) {
                showStatus('advanced', 'Please fix the validation errors above', 'error');
                return;
            }

            const options = getAdvancedAssertOptions();

            try {
                hideStatus('advanced');
                showProgress('advanced', 'Detecting credentials...');

                const response = await fetch('/api/advanced/authenticate/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(options)
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('No credentials detected. Please register a credential first.');
                    }
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }

                const json = await response.json();
                const assertOptions = parseRequestOptionsFromJSON(json);
                
                showProgress('advanced', 'Touch your authenticator device...');

                const assertion = await get(assertOptions);
                
                showProgress('advanced', 'Completing authentication...');

                const result = await fetch('/api/advanced/authenticate/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        response: assertion
                    }),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('advanced', 'Advanced authentication successful!', 'success');
                } else {
                    const errorText = await result.text();
                    throw new Error(`Authentication failed: ${errorText}`);
                }
            } catch (error) {
                console.error('Advanced authentication error:', error);
                
                let errorMessage = error.message;
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'User cancelled or no compatible authenticator detected';
                } else if (error.name === 'InvalidStateError') {
                    errorMessage = 'Invalid authenticator state - please try again';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Security error - check your connection and try again';
                }
                
                showStatus('advanced', `Advanced authentication failed: ${errorMessage}`, 'error');
            } finally {
                hideProgress('advanced');
            }
        }

        async function advancedDelete() {
            const username = document.getElementById('user-name').value;
            if (!username) {
                showStatus('advanced', 'Please enter a username', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete all credentials for ${username}?`)) {
                return;
            }

            try {
                hideStatus('advanced');
                showProgress('advanced', 'Deleting credentials...');

                const result = await fetch('/api/deletepub', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"username": username}),
                });

                if (result.ok) {
                    showStatus('advanced', 'Credentials deleted successfully!', 'success');
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                console.error('Deletion error:', error);
                showStatus('advanced', `Deletion failed: ${error.message}`, 'error');
            } finally {
                hideProgress('advanced');
            }
        }

        // JSON Editor Functions
        function editCreateOptions() {
            const options = getAdvancedCreateOptions();
            currentJsonMode = 'create';
            currentJsonData = options;
            
            document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
            document.getElementById('apply-json').style.display = 'inline-block';
            document.getElementById('cancel-json').style.display = 'inline-block';
        }

        function editAssertOptions() {
            const options = getAdvancedAssertOptions();
            currentJsonMode = 'assert';
            currentJsonData = options;
            
            document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
            document.getElementById('apply-json').style.display = 'inline-block';
            document.getElementById('cancel-json').style.display = 'inline-block';
        }

        function applyJsonChanges() {
            try {
                const jsonText = document.getElementById('json-editor').value;
                const parsed = JSON.parse(jsonText);
                
                if (currentJsonMode === 'create') {
                    // Update create form fields
                    if (parsed.username) document.getElementById('user-name').value = parsed.username;
                    if (parsed.displayName) document.getElementById('user-display-name').value = parsed.displayName;
                    if (parsed.attestation) document.getElementById('attestation').value = parsed.attestation;
                    if (parsed.userVerification) document.getElementById('user-verification-reg').value = parsed.userVerification;
                    if (parsed.authenticatorAttachment !== undefined) document.getElementById('authenticator-attachment').value = parsed.authenticatorAttachment || '';
                    if (parsed.residentKey) document.getElementById('resident-key').value = parsed.residentKey;
                } else if (currentJsonMode === 'assert') {
                    // Update assert form fields
                    if (parsed.userVerification) document.getElementById('user-verification-auth').value = parsed.userVerification;
                }
                
                showStatus('advanced', 'JSON changes applied successfully!', 'success');
                cancelJsonEdit();
            } catch (error) {
                showStatus('advanced', `Invalid JSON: ${error.message}`, 'error');
            }
        }

        function cancelJsonEdit() {
            document.getElementById('json-editor').value = '';
            document.getElementById('apply-json').style.display = 'none';
            document.getElementById('cancel-json').style.display = 'none';
            currentJsonMode = null;
            currentJsonData = {};
        }

        // Decoder Functions
        function decodeResponse() {
            const input = document.getElementById('decoder-input').value;
            if (!input.trim()) {
                showStatus('decoder', 'Please paste a WebAuthn response to decode', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const decoded = analyzeWebAuthnResponse(parsed);
                
                document.getElementById('decoded-content').innerHTML = 
                    `<pre>${JSON.stringify(decoded, null, 2)}</pre>`;
                document.getElementById('decoder-output').style.display = 'block';
                showStatus('decoder', 'Response decoded successfully!', 'success');
            } catch (error) {
                showStatus('decoder', `Decoding failed: ${error.message}`, 'error');
            }
        }

        function clearDecoder() {
            document.getElementById('decoder-input').value = '';
            document.getElementById('decoder-output').style.display = 'none';
            hideStatus('decoder');
        }

        function analyzeWebAuthnResponse(response) {
            const analysis = {
                type: 'Unknown',
                rawResponse: response,
                decodedFields: {}
            };

            // Detect if it's a registration or authentication response
            if (response.response && response.response.attestationObject) {
                analysis.type = 'Registration Response';
                analysis.decodedFields = {
                    credentialId: response.id,
                    credentialType: response.type,
                    authenticatorAttachment: response.authenticatorAttachment,
                    clientDataJSON: tryDecodeBase64Url(response.response.clientDataJSON),
                    attestationObject: 'Base64URL encoded - contains authenticator data and attestation statement'
                };
            } else if (response.response && response.response.authenticatorData) {
                analysis.type = 'Authentication Response';
                analysis.decodedFields = {
                    credentialId: response.id,
                    credentialType: response.type,
                    authenticatorAttachment: response.authenticatorAttachment,
                    clientDataJSON: tryDecodeBase64Url(response.response.clientDataJSON),
                    authenticatorData: 'Base64URL encoded - contains RP ID hash, flags, counter, etc.',
                    signature: 'Base64URL encoded signature'
                };
            }

            return analysis;
        }

        function tryDecodeBase64Url(encoded) {
            try {
                const decoded = atob(encoded.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch (error) {
                return 'Could not decode as JSON: ' + encoded;
            }
        }

        // Update JSON editor when form fields change
        document.addEventListener('DOMContentLoaded', function() {
            const formFields = [
                'user-name', 'user-display-name', 'attestation',
                'user-verification-reg', 'authenticator-attachment', 'resident-key',
                'user-verification-auth'
            ];

            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateJsonFromForm);
                    field.addEventListener('change', updateJsonFromForm);
                }
            });
        });

        function updateJsonFromForm() {
            if (currentJsonMode) {
                if (currentJsonMode === 'create') {
                    const options = getAdvancedCreateOptions();
                    document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
                } else if (currentJsonMode === 'assert') {
                    const options = getAdvancedAssertOptions();
                    document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
                }
            }
        }
    </script>

    <!-- Credential Details Modal -->
    <div id="credentialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Credential Details</h2>
                <button class="modal-close" onclick="closeCredentialModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>