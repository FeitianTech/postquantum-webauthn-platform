<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn FIDO2 Test Application</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #325F74 0%, #4a7b8e 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 300;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .container {
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            transition: all 0.3s ease;
            border-right: 1px solid #dee2e6;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: white;
            color: #325F74;
            font-weight: 500;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
        }

        .content {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h2 {
            color: #325F74;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #325F74;
            box-shadow: 0 0 0 3px rgba(50, 95, 116, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #325F74;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background: #2a4e5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .status {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            min-width: 300px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background: #cce7ff;
            border: 1px solid #b3d7ff;
            color: #004085;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 2fr 0.8fr;
            gap: 2rem;
            margin-top: 1rem;
            align-items: start;
            width: 100%;
        }

        .three-column > div {
            align-self: start;
            min-width: 0; /* Prevent grid overflow */
        }

        .form-column, .json-editor-column, .credentials-column {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .form-column h3, .json-editor-column h3, .credentials-column h3 {
            margin-bottom: 1rem;
            color: #325F74;
            font-size: 1.1rem;
            height: 1.5rem; /* Fixed height for alignment */
        }

        .sub-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .sub-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .sub-tab.active {
            background: white;
            color: #325F74;
            font-weight: 500;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .sub-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .form-control.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .credentials-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            min-height: 600px;
            max-height: 600px;
            overflow-y: auto;
        }

        .credentials-panel h3 {
            margin-bottom: 1rem;
            color: #325F74;
            font-size: 1.1rem;
        }

        .credential-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .credential-item:hover {
            border-color: #325F74;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .credential-item.expanded {
            border-color: #325F74;
        }

        .credential-summary {
            font-weight: 500;
            color: #495057;
        }

        .credential-details {
            display: none;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .credential-item.expanded .credential-details {
            display: block;
        }

        .credential-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            float: right;
            margin-top: 0.5rem;
        }

        .credential-delete:hover {
            background: #c82333;
        }

        .expandable-section {
            margin-bottom: 1rem;
        }

        .section-header {
            cursor: pointer;
            padding: 0.75rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header.expanded {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            background: #e9ecef;
        }

        .section-content {
            display: none;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: white;
        }

        .section-content.expanded {
            display: block;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .json-editor {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 0.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 600px;
            white-space: pre-wrap;
        }

        .json-editor textarea {
            width: 100%;
            height: 100%;
            min-height: 600px;
            background: transparent;
            border: none;
            outline: none;
            resize: vertical;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress {
            display: none;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-align: center;
            margin-top: 1rem;
        }

        .progress.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(50, 95, 116, 0.3);
            border-radius: 50%;
            border-top-color: #325F74;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        select.form-control {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 12px;
        }

        .alert-info {
            color: #055160;
            background-color: #cff4fc;
            border-color: #b6effb;
        }

        .refresh-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #325F74;
            border-top: 2px solid transparent;
            border-radius: 50%;
            background: none;
            padding: 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .refresh-icon:hover {
            transform: rotate(180deg);
        }

        .btn.refresh-icon {
            min-width: auto;
            width: 32px;
            height: 32px;
            border: 2px solid #325F74;
            border-top: 2px solid transparent;
            border-radius: 50%;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn.refresh-icon:hover {
            background: #f8f9fa;
            transform: rotate(180deg);
        }

        .btn.refresh-icon:before {
            content: '';
        }

        /* Info icon styles */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .info-icon:hover {
            background: #495057;
        }

        .info-icon::before {
            content: 'i';
        }

        /* Info popup styles */
        .info-popup {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 500px;
            min-width: 350px;
            font-size: 13px;
            line-height: 1.5;
            color: #333;
            display: none;
            word-wrap: break-word;
        }

        .info-popup.show {
            display: block;
        }

        .info-popup::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .info-popup::after {
            content: '';
            position: absolute;
            top: -9px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 9px solid #dee2e6;
        }

        .label-with-info {
            display: flex;
            align-items: center;
            position: relative;
        }

        /* For screens above 600px - three columns */
        @media (min-width: 601px) {
            .three-column {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 2rem;
            }
        }

        /* For screens 481px to 600px - two columns */
        @media (max-width: 600px) and (min-width: 481px) {
            .three-column {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
        }

        /* For screens below 480px - single column */
        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }

            .two-column,
            .three-column {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .nav-tab:last-child {
                border-bottom: none;
            }
        }



        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: #325F74;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #495057;
        }

        .modal-body {
            line-height: 1.6;
        }

        .modal-body p {
            margin-bottom: 0.75rem;
        }

        .modal-body strong {
            color: #495057;
        }

        .modal-body code {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>WebAuthn FIDO2 Test Application</h1>
        <p>Complete testing suite for WebAuthn authentication with simple and advanced options</p>
    </div>

    <div class="container">
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('simple')">Simple Authentication</button>
            <button class="nav-tab" onclick="switchTab('advanced')">Advanced Authentication</button>
            <button class="nav-tab" onclick="switchTab('decoder')">Decoder</button>
        </nav>

        <div class="content">
            <!-- Simple Authentication Tab -->
            <div id="simple-tab" class="tab-content active">
                <div class="section">
                    <h2>Simple Authentication</h2>
                    <p>Basic WebAuthn operations with minimal configuration - same functionality as the original demo.</p>
                    
                    <div class="status" id="simple-status"></div>

                    <div class="form-group">
                        <label for="simple-email">Email (User Identifier)</label>
                        <input type="email" id="simple-email" class="form-control" placeholder="Enter your email">
                    </div>

                    <div class="form-group">
                        <button class="btn" onclick="simpleRegister()">Register Passkey</button>
                        <button class="btn btn-secondary" onclick="simpleAuthenticate()">Authenticate</button>
                    </div>

                    <div class="progress" id="simple-progress">
                        <div class="spinner"></div>
                        <span id="simple-progress-text">Processing...</span>
                    </div>
                </div>
            </div>

            <!-- Advanced Authentication Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="section">
                    <h2>Advanced Authentication</h2>
                    <p>Comprehensive WebAuthn configuration with full control over registration and assertion options.</p>
                    
                    <div class="status" id="advanced-status"></div>

                    <!-- Sub-tabs for Registration and Authentication -->
                    <div class="sub-tabs">
                        <button id="registration-tab-btn" class="sub-tab active" onclick="switchSubTab('registration')">Registration</button>
                        <button id="authentication-tab-btn" class="sub-tab" onclick="switchSubTab('authentication')">Authentication</button>
                    </div>

                    <div class="three-column">
                        <!-- Left Column: Registration/Authentication Form -->
                        <div class="form-column">
                            <h3>Settings</h3>
                            <!-- Registration Form -->
                            <div id="registration-form" class="sub-tab-content active">
                                <!-- User Identity Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('user-identity')">
                                    <span>User Identity</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="user-identity" class="section-content expanded">
                                    <div class="form-group">
                                        <label for="user-id">User ID (hex)</label>
                                        <div class="input-with-button">
                                            <input type="text" id="user-id" class="form-control" placeholder="Auto-generated hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizeUserId()" title="Generate new random User ID"></button>
                                        </div>
                                        <div id="user-id-error" class="error-message">Invalid hex value (1-64 bytes required)</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-name">User Name</label>
                                        <input type="text" id="user-name" class="form-control" placeholder="Enter username">
                                    </div>
                                    <div class="form-group">
                                        <label for="user-display-name">Display Name</label>
                                        <input type="text" id="user-display-name" class="form-control" placeholder="Auto-generated from username" readonly style="background-color: #f8f9fa; color: #6c757d;">
                                    </div>
                                </div>
                            </div>

                            <!-- Authenticator Selection Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('authenticator-selection')">
                                    <span>Authenticator Selection</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="authenticator-selection" class="section-content">
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="authenticator-attachment">Authenticator Attachment</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Select whether an authenticator integrated into the client platform ("platform") or an external device ("cross-platform") should be used.<br><br>
                                                    If unspecified (the default), either kind of authenticator is allowed.
                                                </div>
                                            </div>
                                        </div>
                                        <select id="authenticator-attachment" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="cross-platform">Cross-platform</option>
                                            <option value="platform">Platform</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="resident-key">Resident Key</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    A resident key can be used for "username-less" authentication, i.e., with an empty allowCredentials parameter.<br><br>
                                                    If "discouraged", a non-resident key will be created if possible. If "preferred", a resident key will be created if possible. If "required", a resident key will be created and the user is shown an error if this fails. If unspecified, the default is "discouraged".
                                                </div>
                                            </div>
                                        </div>
                                        <select id="resident-key" class="form-control">
                                            <option value="discouraged">Discouraged (default)</option>
                                            <option value="preferred">Preferred</option>
                                            <option value="required">Required</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="user-verification-reg">User Verification</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Select whether user verification (UV), for example a PIN or biometric, should be used.<br><br>
                                                    If "discouraged", UV will not be used if possible. If "preferred", UV will be used if possible. If "required", UV will be used and the user is shown an error if this fails. If unspecified, the default is "preferred".
                                                </div>
                                            </div>
                                        </div>
                                        <select id="user-verification-reg" class="form-control">
                                            <option value="preferred">Preferred (default)</option>
                                            <option value="discouraged">Discouraged</option>
                                            <option value="required">Required</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="attestation">Attestation</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Select whether the Relying Party (RP) requires authenticator attestation. Attestation is a way to prove what kind of authenticator is used.<br><br>
                                                    If "none", no authenticator attestation will be returned. If "indirect", some kind of attestation will be returned if possible, but it may be anonymized by an attestation proxy. If "direct", the authenticator's original attestation will be returned, if any. If "enterprise", the authenticator is requested to produce an individually identifying attestation. If unspecified, the default is "none".
                                                </div>
                                            </div>
                                        </div>
                                        <select id="attestation" class="form-control">
                                            <option value="none">None (default)</option>
                                            <option value="indirect">Indirect</option>
                                            <option value="direct">Direct</option>
                                            <option value="enterprise">Enterprise</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label>
                                                <input type="checkbox" id="exclude-credentials" checked> Exclude Credentials
                                            </label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Whether to include an excludeCredentials argument. This is used to prevent creating multiple credentials for the same account by excluding already registered credentials during registration.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="fake-cred-length-reg">Fake credential ID length</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Add a random credential ID of the given length to excludeCredentials. May be useful for testing edge cases and conformance.
                                                </div>
                                            </div>
                                        </div>
                                        <input type="number" id="fake-cred-length-reg" class="form-control" value="128" min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Other Options Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('other-options-reg')">
                                    <span>Other Options</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="other-options-reg" class="section-content">
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="challenge-reg">Challenge (hex)</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    The cryptographic challenge to be signed by the authenticator, used to prevent replay attacks.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="input-with-button">
                                            <input type="text" id="challenge-reg" class="form-control" placeholder="Auto-generated hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizeChallenge('reg')" title="Generate new random challenge"></button>
                                        </div>
                                        <div id="challenge-reg-error" class="error-message">Invalid hex value (minimum 16 bytes required)</div>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="timeout-reg">Timeout (milliseconds)</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    How long the Relying Party (RP) is willing to wait for the registration ceremony to complete. If the registration ceremony takes longer than this (or the adjusted value, in case the client overrides it), the ceremony will be aborted with a timeout message shown to the user. This may be silently overridden by the client.
                                                </div>
                                            </div>
                                        </div>
                                        <input type="number" id="timeout-reg" class="form-control" value="90000" min="1">
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label>Public Key Credential Parameters</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    The signature algorithms supported by the Relying Party (RP). The authenticator will be choosing the most preferred algorithm that it supports. It is recommended to include at least ES256, EdDSA and RS256.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-eddsa" checked>
                                                <label for="param-eddsa">EdDSA</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-es256" checked>
                                                <label for="param-es256">ES256</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs256" checked>
                                                <label for="param-rs256">RS256</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-es384">
                                                <label for="param-es384">ES384</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-es512">
                                                <label for="param-es512">ES512</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs384">
                                                <label for="param-rs384">RS384</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs512">
                                                <label for="param-rs512">RS512</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="param-rs1">
                                                <label for="param-rs1">RS1</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label>Hints</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Registration hints to guide the user-agent in interacting with the user.<br><br>
                                                    Hints are suggestions that help guide the user experience. They're not required, and the system prioritizes them in order of preference. If hints conflict, the first one takes priority. Hints can also overlap, allowing for both specific and general suggestions to be sent. If hints contradict other information, the hints take precedence.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-client-device">
                                                <label for="hint-client-device">Client-device</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-hybrid">
                                                <label for="hint-hybrid">Hybrid</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-security-key">
                                                <label for="hint-security-key">Security-key</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Extensions Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('extensions-reg')">
                                    <span>Extensions</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="extensions-reg" class="section-content">
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label>
                                                <input type="checkbox" id="cred-props" checked> credProps
                                            </label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Request the Credential Properties (credProps) extension. This extension may report properties such as whether a discoverable or non-discoverable credential was created.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label>
                                                <input type="checkbox" id="min-pin-length"> minPinLength
                                            </label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Request the Minimum PIN Length Extension (minPinLength). This extension may report the authenticator's currently configured minimum PIN length if the Relying Party (RP) is authorized to receive this value.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="label-with-info">
                                            <label for="cred-protect">credProtect</label>
                                            <div class="info-icon" onclick="toggleInfoPopup(this)">
                                                <div class="info-popup">
                                                    Request the Credential protection (credProtect) extension. This extension sets whether the authenticator requires user verification (UV) before revealing the existence of a credential. If it does, that also means that the authenticator requires UV before allowing authentication using that credential.
                                                </div>
                                            </div>
                                        </div>
                                        <select id="cred-protect" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="userVerificationOptional">userVerificationOptional</option>
                                            <option value="userVerificationOptionalWithCredentialIdList">userVerificationOptionalWithCredentialIdList</option>
                                            <option value="userVerificationRequired">userVerificationRequired</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="enforce-cred-protect" checked disabled> Enforce credProtect
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="large-blob-reg">largeBlob</label>
                                        <select id="large-blob-reg" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="preferred">Preferred</option>
                                            <option value="required">Required</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="prf-reg" checked> prf
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-first-reg">prf eval first</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-first-reg" class="form-control" placeholder="Hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('first', 'reg')" title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-first-reg-error" class="error-message">Invalid hex value (exactly 32 bytes required)</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-second-reg">prf eval second</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-second-reg" class="form-control" placeholder="Hex value" disabled>
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('second', 'reg')" disabled title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-second-reg-error" class="error-message">Invalid hex value (exactly 32 bytes required)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 2rem;">
                                <button class="btn" onclick="advancedRegister()">Create Credential</button>
                                <button class="btn btn-secondary" onclick="resetRegistrationForm()">Reset</button>
                            </div>
                        </div>

                            <!-- Authentication Form -->
                            <div id="authentication-form" class="sub-tab-content">
                            <!-- Credential Selection Section -->
                            <div class="expandable-section">
                                <div class="section-header expanded" onclick="toggleSection('credential-selection')">
                                    <span>Credential Selection</span>
                                    <span class="expand-icon rotated">▼</span>
                                </div>
                                <div id="credential-selection" class="section-content expanded">
                                    <div class="form-group">
                                        <label for="user-verification-auth">User Verification</label>
                                        <select id="user-verification-auth" class="form-control">
                                            <option value="preferred">Preferred (default)</option>
                                            <option value="discouraged">Discouraged</option>
                                            <option value="required">Required</option>
                                            <option value="">Unspecified</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="allow-credentials">Allow Credentials</label>
                                        <select id="allow-credentials" class="form-control">
                                            <option value="all">All credentials</option>
                                            <option value="empty">Empty (resident key only)</option>
                                        </select>
                                        <div class="alert alert-info" style="margin-top: 0.5rem; font-size: 0.875rem;">
                                            <strong>Note:</strong> When using "Empty (resident key only)", if multiple resident key credentials exist on your authenticator from previous registrations, you may still be prompted to select one. This is because web applications cannot delete credentials from authenticators directly. To test true discoverable credential authentication, you may need to reset your authenticator or use device-specific management tools to clear old credentials.
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="fake-cred-length-auth">Fake credential ID length</label>
                                        <input type="number" id="fake-cred-length-auth" class="form-control" value="256" min="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Other Options Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('other-options-auth')">
                                    <span>Other Options</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="other-options-auth" class="section-content">
                                    <div class="form-group">
                                        <label for="challenge-auth">Challenge (hex)</label>
                                        <div class="input-with-button">
                                            <input type="text" id="challenge-auth" class="form-control" placeholder="Auto-generated hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizeChallenge('auth')" title="Generate new random challenge"></button>
                                        </div>
                                        <div id="challenge-auth-error" class="error-message">Invalid hex value (minimum 16 bytes required)</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="timeout-auth">Timeout (milliseconds)</label>
                                        <input type="number" id="timeout-auth" class="form-control" value="90000" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Hints</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-client-device-auth">
                                                <label for="hint-client-device-auth">Client-device</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-hybrid-auth">
                                                <label for="hint-hybrid-auth">Hybrid</label>
                                            </div>
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="hint-security-key-auth">
                                                <label for="hint-security-key-auth">Security-key</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Extensions Section -->
                            <div class="expandable-section">
                                <div class="section-header" onclick="toggleSection('extensions-auth')">
                                    <span>Extensions</span>
                                    <span class="expand-icon">▼</span>
                                </div>
                                <div id="extensions-auth" class="section-content">
                                    <div class="form-group">
                                        <label for="large-blob-auth">largeBlob</label>
                                        <select id="large-blob-auth" class="form-control">
                                            <option value="">Unspecified (default)</option>
                                            <option value="read">Read</option>
                                            <option value="write">Write</option>
                                        </select>
                                        <div id="large-blob-capability-message" class="error-message" style="color: #6c757d; display: none;">No largeBlob capable credentials available</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="large-blob-write">largeBlob write</label>
                                        <div class="input-with-button">
                                            <input type="text" id="large-blob-write" class="form-control" placeholder="Hex value" disabled>
                                            <button class="btn btn-small refresh-icon" onclick="randomizeLargeBlobWrite()" disabled title="Generate random large blob data"></button>
                                        </div>
                                        <div id="large-blob-write-error" class="error-message">Invalid hex value</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-first-auth">prf eval first</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-first-auth" class="form-control" placeholder="Hex value">
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('first', 'auth')" title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-first-auth-error" class="error-message">Invalid hex value (exactly 32 bytes required)</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="prf-eval-second-auth">prf eval second</label>
                                        <div class="input-with-button">
                                            <input type="text" id="prf-eval-second-auth" class="form-control" placeholder="Hex value" disabled>
                                            <button class="btn btn-small refresh-icon" onclick="randomizePrfEval('second', 'auth')" disabled title="Generate random PRF evaluation data"></button>
                                        </div>
                                        <div id="prf-eval-second-auth-error" class="error-message">Invalid hex value (exactly 32 bytes required)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 2rem;">
                                <button class="btn" onclick="advancedAuthenticate()">Assert Credential</button>
                                <button class="btn btn-secondary" onclick="resetAuthenticationForm()">Reset</button>
                            </div>
                        </div>
                        </div>

                        <!-- Middle Column: JSON Editor -->
                        <div class="json-editor-column">
                            <h3>JSON Editor</h3>
                            <div id="json-editor-container" class="json-editor">
                                <textarea id="json-editor" placeholder="JSON representation will appear here automatically..."></textarea>
                            </div>
                            <div class="json-editor-buttons" style="margin-top: 0.5rem;">
                                <button class="btn" onclick="saveJsonEditor()" title="Save JSON changes to settings">Save</button>
                                <button class="btn btn-secondary" onclick="resetJsonEditor()" title="Reset JSON to match current settings">Reset</button>
                            </div>
                        </div>

                        <!-- Right Column: Credentials Panel -->
                        <div class="credentials-column">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label for="binary-format">Binary Format</label>
                                <select id="binary-format" class="form-control" onchange="changeBinaryFormat()">
                                    <option value="hex">hex</option>
                                    <option value="b64">b64</option>
                                    <option value="b64u">b64u</option>
                                    <option value="js">js</option>
                                </select>
                            </div>
                            <h3>Saved Credentials</h3>
                            <div class="credentials-panel">
                                <div id="credentials-list">
                                    <p style="color: #6c757d; font-style: italic;">No credentials registered yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress" id="advanced-progress">
                        <div class="spinner"></div>
                        <span id="advanced-progress-text">Processing...</span>
                    </div>
            </div>

            <!-- Decoder Tab -->
            <div id="decoder-tab" class="tab-content">
                <div class="section">
                    <h2>WebAuthn Response Decoder</h2>
                    <p>Decode and analyze WebAuthn authentication responses, credential data, and attestation objects.</p>
                    
                    <div class="status" id="decoder-status"></div>

                    <div class="form-group">
                        <label for="decoder-input">Paste WebAuthn Response JSON</label>
                        <textarea id="decoder-input" class="form-control" rows="10" placeholder="Paste your WebAuthn registration or authentication response here..."></textarea>
                    </div>

                    <div class="form-group">
                        <button class="btn" onclick="decodeResponse()">Decode Response</button>
                        <button class="btn btn-secondary" onclick="clearDecoder()">Clear</button>
                    </div>

                    <div id="decoder-output" style="display: none;">
                        <h3>Decoded Information</h3>
                        <div id="decoded-content" class="json-editor">
                            <!-- Decoded output will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import {
            create,
            get,
            parseCreationOptionsFromJSON,
            parseRequestOptionsFromJSON,
        } from '/webauthn-json.browser-ponyfill.js';

        // Make functions globally available
        window.create = create;
        window.get = get;
        window.parseCreationOptionsFromJSON = parseCreationOptionsFromJSON;
        window.parseRequestOptionsFromJSON = parseRequestOptionsFromJSON;
    </script>

    <script>
        let currentSubTab = 'registration';
        let storedCredentials = [];
        let currentJsonMode = null;
        let currentJsonData = null;

        // Info popup functionality
        function toggleInfoPopup(iconElement) {
            const popup = iconElement.querySelector('.info-popup');
            const isCurrentlyVisible = popup.classList.contains('show');
            
            // Hide all other popups
            document.querySelectorAll('.info-popup.show').forEach(p => p.classList.remove('show'));
            
            // Toggle current popup
            if (!isCurrentlyVisible) {
                popup.classList.add('show');
                
                // Close popup when clicking elsewhere
                setTimeout(() => {
                    document.addEventListener('click', function closePopup(e) {
                        if (!iconElement.contains(e.target)) {
                            popup.classList.remove('show');
                            document.removeEventListener('click', closePopup);
                        }
                    });
                }, 10);
            }
        }



        function isValidHex(str) {
            return /^[0-9a-fA-F]*$/.test(str) && str.length > 0;
        }

        function generateRandomHex(bytes) {
            const array = new Uint8Array(bytes);
            crypto.getRandomValues(array);
            return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Convert hex string to base64url format for WebAuthn JSON
        function hexToBase64Url(hexString) {
            if (!hexString) return '';
            
            // Ensure hex string has even length
            if (hexString.length % 2 !== 0) {
                hexString = '0' + hexString;
            }
            
            // Convert hex to bytes
            const bytes = new Uint8Array(hexString.match(/.{2}/g).map(byte => parseInt(byte, 16)));
            
            // Convert to base64
            const base64 = btoa(String.fromCharCode(...bytes));
            
            // Convert to base64url (URL-safe base64)
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Convert base64url back to hex string
        function base64UrlToHex(base64url) {
            if (!base64url) return '';
            
            // Convert base64url to regular base64
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            
            // Add padding if needed
            while (base64.length % 4) {
                base64 += '=';
            }
            
            // Decode base64 to bytes
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            // Convert bytes to hex
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Convert base64 to base64url
        function base64ToBase64Url(base64) {
            if (!base64) return '';
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Convert hex to regular base64
        function hexToBase64(hexString) {
            if (!hexString) return '';
            
            // Convert hex to bytes
            const bytes = new Uint8Array(hexString.match(/.{2}/g).map(byte => parseInt(byte, 16)));
            
            // Convert to base64
            return btoa(String.fromCharCode(...bytes));
        }

        // Convert hex to GUID format (for AAGUID display)
        function hexToGuid(hexString) {
            if (!hexString || hexString.length !== 32) return '';
            
            // Format as GUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
            return [
                hexString.substring(0, 8),
                hexString.substring(8, 12),
                hexString.substring(12, 16),
                hexString.substring(16, 20),
                hexString.substring(20, 32)
            ].join('-');
        }

        // Convert hex to JavaScript Uint8Array format
        function hexToJs(hexString) {
            if (!hexString) return '';
            
            // Convert hex to bytes
            const bytes = [];
            for (let i = 0; i < hexString.length; i += 2) {
                bytes.push(parseInt(hexString.substr(i, 2), 16));
            }
            
            return `new Uint8Array([${bytes.join(', ')}])`;
        }

        // Convert base64 to hex
        function base64ToHex(base64) {
            if (!base64) return '';
            
            // Decode base64 to bytes
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            // Convert bytes to hex
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Convert base64url to hex
        function base64UrlToHexFixed(base64url) {
            if (!base64url) return '';
            
            // Convert base64url to regular base64
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            
            // Add padding if needed
            while (base64.length % 4) {
                base64 += '=';
            }
            
            return base64ToHex(base64);
        }

        // Convert JavaScript Uint8Array format to hex
        function jsToHex(jsString) {
            if (!jsString) return '';
            
            // Extract numbers from the Uint8Array string
            const match = jsString.match(/new Uint8Array\(\[([0-9, ]+)\]\)/);
            if (!match) return '';
            
            const numbers = match[1].split(',').map(n => parseInt(n.trim()));
            return numbers.map(n => n.toString(16).padStart(2, '0')).join('');
        }

        // Convert value from one format to another
        function convertFormat(value, fromFormat, toFormat) {
            if (!value || fromFormat === toFormat) return value;
            
            // First convert to hex as intermediate format
            let hexValue = '';
            switch (fromFormat) {
                case 'hex':
                    hexValue = value;
                    break;
                case 'b64':
                    hexValue = base64ToHex(value);
                    break;
                case 'b64u':
                    hexValue = base64UrlToHexFixed(value);
                    break;
                case 'js':
                    hexValue = jsToHex(value);
                    break;
            }
            
            // Then convert from hex to target format
            switch (toFormat) {
                case 'hex':
                    return hexValue;
                case 'b64':
                    return hexToBase64(hexValue);
                case 'b64u':
                    return hexToBase64Url(hexValue);
                case 'js':
                    return hexToJs(hexValue);
                default:
                    return hexValue;
            }
        }

        // Get current binary format
        function getCurrentBinaryFormat() {
            return document.getElementById('binary-format').value;
        }

        // Change binary format for all relevant fields
        function changeBinaryFormat() {
            const newFormat = getCurrentBinaryFormat();
            const oldFormat = window.currentBinaryFormat || 'hex';
            
            // Update all hex input fields
            const fieldIds = [
                'user-id', 'challenge-reg', 'challenge-auth',
                'prf-eval-first-reg', 'prf-eval-second-reg',
                'prf-eval-first-auth', 'prf-eval-second-auth',
                'large-blob-write'
            ];
            
            fieldIds.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input && input.value) {
                    const convertedValue = convertFormat(input.value, oldFormat, newFormat);
                    input.value = convertedValue;
                }
            });
            
            // Update field labels
            updateFieldLabels(newFormat);
            
            // Update JSON editor
            updateJsonEditor();
            
            // Store current format for next change
            window.currentBinaryFormat = newFormat;
        }

        // Update field labels to show current format
        function updateFieldLabels(format) {
            const labelMappings = [
                { id: 'user-id', text: `User ID (${format})` },
                { id: 'challenge-reg', text: `Challenge (${format})` },
                { id: 'challenge-auth', text: `Challenge (${format})` },
                { id: 'prf-eval-first-reg', text: `prf eval first (${format})` },
                { id: 'prf-eval-second-reg', text: `prf eval second (${format})` },
                { id: 'prf-eval-first-auth', text: `prf eval first (${format})` },
                { id: 'prf-eval-second-auth', text: `prf eval second (${format})` },
                { id: 'large-blob-write', text: `largeBlob write (${format})` }
            ];
            
            labelMappings.forEach(mapping => {
                const input = document.getElementById(mapping.id);
                if (input) {
                    const label = document.querySelector(`label[for="${mapping.id}"]`);
                    if (label) {
                        label.textContent = mapping.text;
                    }
                }
            });
        }

        function validateHexInput(inputId, errorId, minBytes = 0) {
            const input = document.getElementById(inputId);
            const error = document.getElementById(errorId);
            const value = input.value.trim();
            const format = getCurrentBinaryFormat();
            
            if (!value) {
                error.style.display = 'none';
                input.classList.remove('error');
                return true;
            }
            
            let isValid = false;
            let hexValue = '';
            
            try {
                // Convert to hex for validation
                switch (format) {
                    case 'hex':
                        isValid = /^[0-9a-fA-F]+$/.test(value) && value.length >= minBytes * 2;
                        hexValue = value;
                        break;
                    case 'b64':
                        hexValue = base64ToHex(value);
                        isValid = hexValue.length >= minBytes * 2;
                        break;
                    case 'b64u':
                        hexValue = base64UrlToHexFixed(value);
                        isValid = hexValue.length >= minBytes * 2;
                        break;
                    case 'js':
                        hexValue = jsToHex(value);
                        isValid = hexValue.length >= minBytes * 2;
                        break;
                }
            } catch (e) {
                isValid = false;
            }
            
            if (!isValid) {
                error.style.display = 'block';
                input.classList.add('error');
                return false;
            } else {
                error.style.display = 'none';
                input.classList.remove('error');
                return true;
            }
        }

        // Tab switching functionality
        function switchTab(tab) {
            // Debug logging with fallback
            if (window.console && console.log) {
                console.log('Switching to tab:', tab);
            }
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });

            // Show selected tab
            const targetTab = document.getElementById(tab + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
                if (window.console && console.log) {
                    console.log('Activated tab:', targetTab.id);
                }
            } else {
                if (window.console && console.error) {
                    console.error('Tab not found:', tab + '-tab');
                }
            }
            
            // Activate the corresponding nav button - use a more direct approach
            const navButtons = document.querySelectorAll('.nav-tab');
            const tabNames = ['simple', 'advanced', 'decoder'];
            const tabIndex = tabNames.indexOf(tab);
            
            if (tabIndex !== -1 && navButtons[tabIndex]) {
                navButtons[tabIndex].classList.add('active');
                if (window.console && console.log) {
                    console.log('Activated nav button:', tabIndex);
                }
            }
            
            // Update JSON editor if in advanced tab
            if (tab === 'advanced') {
                updateJsonEditor();
            }
        }

        // Sub-tab switching for Registration/Authentication
        function switchSubTab(subTab) {
            currentSubTab = subTab;
            
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(subTab + '-tab-btn').classList.add('active');
            
            // Update sub-tab content
            document.querySelectorAll('.sub-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subTab + '-form').classList.add('active');
            
            // Update JSON editor
            updateJsonEditor();
        }

        // Section toggle functionality
        function toggleSection(sectionId) {
            const header = event.currentTarget;
            const content = document.getElementById(sectionId);
            const icon = header.querySelector('.expand-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
            }
        }

        // Randomization functions
        function randomizeUserId() {
            const userId = generateRandomHex(32);
            const format = getCurrentBinaryFormat();
            const formattedValue = convertFormat(userId, 'hex', format);
            document.getElementById('user-id').value = formattedValue;
            updateJsonEditor();
        }

        function randomizeChallenge(type) {
            const challenge = generateRandomHex(32);  // 32 bytes = 64 hex chars
            const format = getCurrentBinaryFormat();
            const formattedValue = convertFormat(challenge, 'hex', format);
            document.getElementById('challenge-' + type).value = formattedValue;
            updateJsonEditor();
        }

        function randomizePrfEval(evalType, formType) {
            const prfValue = generateRandomHex(32);  // 32 bytes = 64 hex chars
            const format = getCurrentBinaryFormat();
            const formattedValue = convertFormat(prfValue, 'hex', format);
            document.getElementById('prf-eval-' + evalType + '-' + formType).value = formattedValue;
            
            // Enable/disable second PRF eval based on first
            if (evalType === 'first') {
                const secondInput = document.getElementById('prf-eval-second-' + formType);
                const secondButton = secondInput.nextElementSibling;
                if (formattedValue) {
                    secondInput.disabled = false;
                    secondButton.disabled = false;
                } else {
                    secondInput.disabled = true;
                    secondButton.disabled = true;
                    secondInput.value = '';
                }
            }
            
            updateJsonEditor();
        }

        function randomizeLargeBlobWrite() {
            const blobValue = generateRandomHex(32);  // 32 bytes = 64 hex chars
            const format = getCurrentBinaryFormat();
            const formattedValue = convertFormat(blobValue, 'hex', format);
            document.getElementById('large-blob-write').value = formattedValue;
            updateJsonEditor();
        }

        function validatePrfInputs(formType) {
            const firstInput = document.getElementById('prf-eval-first-' + formType);
            const secondInput = document.getElementById('prf-eval-second-' + formType);
            const secondButton = secondInput.nextElementSibling;
            
            if (firstInput.value.trim() === '') {
                secondInput.disabled = true;
                secondButton.disabled = true;
                secondInput.value = '';
            } else {
                secondInput.disabled = false;
                secondButton.disabled = false;
            }
            
            updateJsonEditor();
        }

        function validateUserIdInput() {
            return validateHexInput('user-id', 'user-id-error', 1); // 1-64 bytes
        }

        function validateChallengeInputs() {
            let valid = true;
            const challengeRegInput = document.getElementById('challenge-reg');
            const challengeAuthInput = document.getElementById('challenge-auth');
            
            if (challengeRegInput) valid &= validateHexInput('challenge-reg', 'challenge-reg-error', 16); // min 16 bytes
            if (challengeAuthInput) valid &= validateHexInput('challenge-auth', 'challenge-auth-error', 16); // min 16 bytes
            
            return valid;
        }

        function validatePrfEvalInputs() {
            const prfInputs = [
                'prf-eval-first-reg', 
                'prf-eval-second-reg',
                'prf-eval-first-auth', 
                'prf-eval-second-auth'
            ];
            
            let valid = true;
            prfInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && !input.disabled && input.value.trim()) {
                    valid &= validateHexInput(inputId, inputId + '-error', 32); // exactly 32 bytes
                }
            });
            
            return valid;
        }

        function validateLargeBlobWriteInput() {
            const input = document.getElementById('large-blob-write');
            if (input && !input.disabled && input.value.trim()) {
                return validateHexInput('large-blob-write', 'large-blob-write-error', 1); // at least 1 byte
            }
            return true;
        }

        function validateLargeBlobDependency() {
            const largeBlobReg = document.getElementById('large-blob-reg')?.value;
            const residentKey = document.getElementById('resident-key')?.value;
            
            // If largeBlob is set to preferred or required, resident key must be required
            if (largeBlobReg && (largeBlobReg === 'preferred' || largeBlobReg === 'required')) {
                if (residentKey !== 'required') {
                    showStatus('advanced', 'LargeBlob extensions require resident key to be set to "Required"', 'error');
                    return false;
                }
            }
            return true;
        }

        function checkLargeBlobCapability() {
            // Check if any saved credentials actually support large blob
            let hasLargeBlobCapability = false;
            
            // Check actual credential data for largeBlob support
            if (storedCredentials && storedCredentials.length > 0) {
                hasLargeBlobCapability = storedCredentials.some(cred => cred.largeBlob === true);
            }
            
            const largeBlobSelect = document.getElementById('large-blob-auth');
            const largeBlobWriteInput = document.getElementById('large-blob-write');
            const largeBlobWriteButton = largeBlobWriteInput?.nextElementSibling;
            const messageElement = document.getElementById('large-blob-capability-message');
            const readOption = largeBlobSelect?.querySelector('option[value="read"]');
            const writeOption = largeBlobSelect?.querySelector('option[value="write"]');
            
            if (hasLargeBlobCapability) {
                // Enable largeBlob read/write options
                if (readOption) readOption.disabled = false;
                if (writeOption) writeOption.disabled = false;
                if (messageElement) messageElement.style.display = 'none';
                
                // Enable/disable write input based on selection
                const currentValue = largeBlobSelect?.value;
                if (largeBlobWriteInput && largeBlobWriteButton) {
                    if (currentValue === 'write') {
                        largeBlobWriteInput.disabled = false;
                        largeBlobWriteButton.disabled = false;
                    } else {
                        largeBlobWriteInput.disabled = true;
                        largeBlobWriteButton.disabled = true;
                    }
                }
            } else {
                // Disable largeBlob read/write options
                if (readOption) readOption.disabled = true;
                if (writeOption) writeOption.disabled = true;
                if (largeBlobWriteInput) largeBlobWriteInput.disabled = true;
                if (largeBlobWriteButton) largeBlobWriteButton.disabled = true;
                if (messageElement) messageElement.style.display = 'block';
                
                // Reset selection to default
                if (largeBlobSelect) largeBlobSelect.value = '';
            }
        }

        // Auto-detect and load PKL credentials
        async function loadSavedCredentials() {
            try {
                const response = await fetch('/api/credentials', {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'}
                });

                if (response.ok) {
                    const credentials = await response.json();
                    storedCredentials = credentials;
                    updateCredentialsDisplay();
                    updateJsonEditor(); // Update JSON editor in case allowCredentials needs updating
                } else {
                    console.warn('Failed to load saved credentials');
                }
            } catch (error) {
                console.error('Error loading saved credentials:', error);
            }
        }

        function updateCredentialsDisplay() {
            const credentialsList = document.getElementById('credentials-list');
            
            if (storedCredentials.length === 0) {
                credentialsList.innerHTML = '<p style="color: #6c757d; font-style: italic;">No credentials registered yet.</p>';
                checkLargeBlobCapability(); // Check capability when no credentials
                updateAllowCredentialsDropdown(); // Update dropdown when no credentials
                return;
            }

            credentialsList.innerHTML = storedCredentials.map((cred, index) => `
                <div class="credential-item" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; color: #495057; font-size: 0.9rem; margin-bottom: 0.25rem;">${cred.email || cred.username || 'Unknown User'}</div>
                        <div style="font-size: 0.75rem; color: #6c757d;">
                            ${cred.algorithm || 'Unknown'} • ${cred.createdAt ? new Date(cred.createdAt).toLocaleDateString() : 'Unknown date'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                        <button class="btn-small" onclick="showCredentialDetails(${index})" style="background: #325F74; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Details</button>
                        <button class="btn-small btn-danger" onclick="deleteCredential('${cred.email || cred.username}', ${index})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Delete</button>
                    </div>
                </div>
            `).join('');
            
            // Check large blob capability after updating display
            checkLargeBlobCapability();
            
            // Update allow credentials dropdown with individual credentials
            updateAllowCredentialsDropdown();
        }

        function updateAllowCredentialsDropdown() {
            const allowCredentialsSelect = document.getElementById('allow-credentials');
            if (!allowCredentialsSelect) return;
            
            // Store current selection
            const currentValue = allowCredentialsSelect.value;
            
            // Clear existing options except the default ones
            allowCredentialsSelect.innerHTML = `
                <option value="all">All credentials</option>
                <option value="empty">Empty (resident key only)</option>
            `;
            
            // Add individual credential options
            if (storedCredentials && storedCredentials.length > 0) {
                storedCredentials.forEach((cred, index) => {
                    const credName = cred.userName || cred.email || `Credential ${index + 1}`;
                    const option = document.createElement('option');
                    option.value = cred.credentialId;
                    option.textContent = `${credName} (${cred.algorithm || 'Unknown'})`;
                    allowCredentialsSelect.appendChild(option);
                });
            }
            
            // Restore selection if it's still valid
            if (currentValue && Array.from(allowCredentialsSelect.options).some(opt => opt.value === currentValue)) {
                allowCredentialsSelect.value = currentValue;
            } else {
                allowCredentialsSelect.value = 'all'; // Default to all if current selection is invalid
            }
            
            // Update JSON editor when dropdown is updated
            updateJsonEditor();
        }

        function showCredentialDetails(index) {
            const cred = storedCredentials[index];
            if (!cred) return;

            const modalBody = document.getElementById('modalBody');
            
            // Helper functions for format conversion
            function base64UrlToHex(base64url) {
                try {
                    // Convert base64url to regular base64
                    let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                    while (base64.length % 4) {
                        base64 += '=';
                    }
                    // Convert to bytes and then to hex
                    const bytes = atob(base64);
                    return Array.from(bytes, byte => byte.charCodeAt(0).toString(16).padStart(2, '0')).join('');
                } catch (e) {
                    return 'Invalid data';
                }
            }
            
            function hexToBase64(hex) {
                try {
                    const bytes = hex.match(/.{2}/g).map(byte => String.fromCharCode(parseInt(byte, 16))).join('');
                    return btoa(bytes);
                } catch (e) {
                    return 'Invalid data';
                }
            }
            
            function base64ToBase64Url(base64) {
                return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            }
            
            function hexToGuid(hex) {
                if (hex.length !== 32) return 'Invalid GUID';
                return `${hex.substr(0,8)}-${hex.substr(8,4)}-${hex.substr(12,4)}-${hex.substr(16,4)}-${hex.substr(20,12)}`;
            }
            
            // Construct the detailed credential information in the exact format requested
            let detailsHtml = '';
            
            // User info at creation
            detailsHtml += `
            <div style="margin-bottom: 1.5rem;">
                <h4 style="color: #325F74; margin-bottom: 0.5rem;">User info at creation</h4>
                <div style="font-size: 0.9rem; line-height: 1.4;">
                    <div><strong>Name:</strong> ${cred.userName || cred.email || 'N/A'}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Display name:</strong> ${cred.displayName || cred.userName || cred.email || 'N/A'}</div>
                </div>`;
            
            // User handle (User ID) section
            if (cred.userHandle) {
                const userHandleB64 = cred.userHandle;
                const userHandleB64u = base64ToBase64Url(userHandleB64);
                const userHandleHex = base64UrlToHex(userHandleB64u);
                
                detailsHtml += `
                <div style="margin-top: 0.5rem;">
                    <div><strong>User handle (User ID):</strong></div>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9rem; margin-left: 1rem;">
                        <div><strong>b64</strong></div>
                        <div style="background: #f8f9fa; padding: 0.25rem; border-radius: 4px; margin-bottom: 0.25rem;">${userHandleB64}</div>
                        <div><strong>b64u</strong></div>
                        <div style="background: #f8f9fa; padding: 0.25rem; border-radius: 4px; margin-bottom: 0.25rem;">${userHandleB64u}</div>
                        <div><strong>hex</strong></div>
                        <div style="background: #f8f9fa; padding: 0.25rem; border-radius: 4px;">${userHandleHex}</div>
                    </div>
                </div>`;
            }
            
            detailsHtml += `</div>`;
            
            // Properties section
            detailsHtml += `
            <div style="margin-bottom: 1.5rem;">
                <h4 style="color: #325F74; margin-bottom: 0.5rem;">Properties</h4>
                <div style="font-size: 0.9rem; line-height: 1.4;">
                    <div><strong>Discoverable (resident key):</strong> ${cred.residentKey || false}</div>
                    <div><strong>Supports largeBlob:</strong> ${cred.largeBlob || false}</div>
                </div>
            </div>`;
            
            // Attestation Format - only show if not 'none'
            if (cred.attestationFormat && cred.attestationFormat !== 'none') {
                detailsHtml += `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #325F74; margin-bottom: 0.5rem;">Attestation Format</h4>
                    <div style="font-size: 0.9rem;">${cred.attestationFormat}</div>
                </div>`;
                
                // Show attestation statement if available
                if (cred.attestationStatement && Object.keys(cred.attestationStatement).length > 0) {
                    detailsHtml += `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #325F74; margin-bottom: 0.5rem;">Attestation Statement</h4>
                        <div style="font-size: 0.8rem; font-family: monospace; background: #f8f9fa; padding: 0.5rem; border-radius: 4px; white-space: pre-wrap;">${JSON.stringify(cred.attestationStatement, null, 2)}</div>
                    </div>`;
                }
            }
            
            // Authenticator Data (registration)
            if (cred.flags) {
                detailsHtml += `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #325F74; margin-bottom: 0.5rem;">Authenticator Data (registration)</h4>
                    <div style="font-size: 0.9rem; line-height: 1.4;">
                        <div><strong>AT:</strong> ${cred.flags.at}, <strong>BE:</strong> ${cred.flags.be}, <strong>BS:</strong> ${cred.flags.bs}, <strong>ED:</strong> ${cred.flags.ed}, <strong>UP:</strong> ${cred.flags.up}, <strong>UV:</strong> ${cred.flags.uv}</div>
                        <div><strong>Signature Counter:</strong> ${cred.signCount || 0}</div>
                    </div>
                </div>`;
            }
            
            // Client extension outputs (registration)
            if (cred.clientExtensionOutputs && Object.keys(cred.clientExtensionOutputs).length > 0) {
                detailsHtml += `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #325F74; margin-bottom: 0.5rem;">Client extension outputs (registration)</h4>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9rem; background: #f8f9fa; padding: 0.5rem; border-radius: 4px; white-space: pre-wrap;">${JSON.stringify(cred.clientExtensionOutputs, null, 2)}</div>
                </div>`;
            }
            
            // Public Key section
            if (cred.publicKeyAlgorithm || cred.algorithm) {
                const algo = cred.publicKeyAlgorithm || cred.algorithm;
                let algorithmName = 'Unknown';
                if (algo === -7) algorithmName = 'ES256 (-7)';
                else if (algo === -257) algorithmName = 'RS256 (-257)';
                else if (algo === -37) algorithmName = 'PS256 (-37)';
                else if (algo === -8) algorithmName = 'EdDSA (-8)';
                else if (algo === -48) algorithmName = 'ML-DSA-44 (PQC) (-48)';
                else if (algo === -49) algorithmName = 'ML-DSA-65 (PQC) (-49)';
                else if (typeof algo === 'number') algorithmName = `Algorithm (${algo})`;
                else algorithmName = algo;
                
                detailsHtml += `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #325F74; margin-bottom: 0.5rem;">Public Key</h4>
                    <div style="font-size: 0.9rem;">
                        <div><strong>Algorithm:</strong> ${algorithmName}</div>
                    </div>
                </div>`;
            }
            
            modalBody.innerHTML = detailsHtml;
            document.getElementById('credentialModal').style.display = 'block';
        }

        function closeCredentialModal() {
            document.getElementById('credentialModal').style.display = 'none';
        }

        async function deleteCredential(username, index) {
            if (!confirm(`Are you sure you want to delete the credential for ${username}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/deletepub', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"email": username})
                });

                if (response.ok) {
                    // Remove from local array
                    storedCredentials.splice(index, 1);
                    updateCredentialsDisplay();
                    
                    // Show success message with important note about authenticator credentials
                    showStatus('advanced', 
                        'Credential deleted from server successfully! ' +
                        'Note: This only removes the credential from our application. ' +
                        'The credential remains on your authenticator device and may still appear during resident key authentication. ' +
                        'To fully remove credentials, you may need to reset your authenticator or use device-specific management tools.', 
                        'success'
                    );
                } else {
                    throw new Error('Failed to delete credential from server');
                }
            } catch (error) {
                console.error('Error deleting credential:', error);
                showStatus('advanced', `Failed to delete credential: ${error.message}`, 'error');
            }
        }



        // Reset functions
        function resetRegistrationForm() {
            // Reset User Identity
            document.getElementById('user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-display-name').value = '';
            
            // Reset Authenticator Selection
            document.getElementById('authenticator-attachment').value = '';
            document.getElementById('resident-key').value = 'discouraged';
            document.getElementById('user-verification-reg').value = 'preferred';
            document.getElementById('attestation').value = 'none';
            document.getElementById('exclude-credentials').checked = true;
            document.getElementById('fake-cred-length-reg').value = '128';
            
            // Reset Other Options
            document.getElementById('challenge-reg').value = '';
            document.getElementById('timeout-reg').value = '90000';
            document.getElementById('param-eddsa').checked = true;
            document.getElementById('param-es256').checked = true;
            document.getElementById('param-rs256').checked = true;
            document.getElementById('param-es384').checked = false;
            document.getElementById('param-es512').checked = false;
            document.getElementById('param-rs384').checked = false;
            document.getElementById('param-rs512').checked = false;
            document.getElementById('param-rs1').checked = false;
            document.getElementById('hint-client-device').checked = false;
            document.getElementById('hint-hybrid').checked = false;
            document.getElementById('hint-security-key').checked = false;
            
            // Reset Extensions
            document.getElementById('cred-props').checked = true;
            document.getElementById('min-pin-length').checked = false;
            document.getElementById('cred-protect').value = '';
            document.getElementById('enforce-cred-protect').checked = true;
            document.getElementById('enforce-cred-protect').disabled = true;
            document.getElementById('large-blob-reg').value = '';
            document.getElementById('prf-reg').checked = true;
            document.getElementById('prf-eval-first-reg').value = '';
            document.getElementById('prf-eval-second-reg').value = '';
            document.getElementById('prf-eval-second-reg').disabled = true;
            
            updateJsonEditor();
        }

        function resetAuthenticationForm() {
            // Reset Credential Selection
            document.getElementById('user-verification-auth').value = 'preferred';
            document.getElementById('allow-credentials').value = 'all';
            document.getElementById('fake-cred-length-auth').value = '256';
            
            // Reset Other Options
            document.getElementById('challenge-auth').value = '';
            document.getElementById('timeout-auth').value = '90000';
            document.getElementById('hint-client-device-auth').checked = false;
            document.getElementById('hint-hybrid-auth').checked = false;
            document.getElementById('hint-security-key-auth').checked = false;
            
            // Reset Extensions
            document.getElementById('large-blob-auth').value = '';
            document.getElementById('large-blob-write').value = '';
            document.getElementById('large-blob-write').disabled = true;
            document.getElementById('prf-eval-first-auth').value = '';
            document.getElementById('prf-eval-second-auth').value = '';
            document.getElementById('prf-eval-second-auth').disabled = true;
            
            updateJsonEditor();
        }

        // JSON Editor update function
        function updateJsonEditor() {
            let options = {};
            let title = 'JSON Editor';
            
            if (currentSubTab === 'registration') {
                options = getCredentialCreationOptions();
                title = 'JSON Editor (CredentialCreationOptions)';
            } else if (currentSubTab === 'authentication') {
                options = getCredentialRequestOptions();
                title = 'JSON Editor (CredentialRequestOptions)';
            }
            
            const jsonEditor = document.getElementById('json-editor');
            if (jsonEditor) {
                jsonEditor.value = JSON.stringify(options, null, 2);
            }
            
            // Update the title
            const titleElement = document.querySelector('.json-editor-column h3');
            if (titleElement) {
                titleElement.textContent = title;
            }
        }

        // Save JSON Editor changes to settings
        function saveJsonEditor() {
            try {
                const jsonText = document.getElementById('json-editor').value;
                const parsed = JSON.parse(jsonText);
                
                // Validate the structure
                if (!parsed.publicKey) {
                    throw new Error('Invalid JSON structure: Missing "publicKey" property');
                }
                
                const publicKey = parsed.publicKey;
                
                if (currentSubTab === 'registration') {
                    // Validate CredentialCreationOptions structure
                    if (!publicKey.rp || !publicKey.user || !publicKey.challenge) {
                        throw new Error('Invalid CredentialCreationOptions: Missing required properties (rp, user, challenge)');
                    }
                    
                    // Update form fields from JSON
                    updateRegistrationFormFromJson(publicKey);
                } else if (currentSubTab === 'authentication') {
                    // Validate CredentialRequestOptions structure
                    if (!publicKey.challenge) {
                        throw new Error('Invalid CredentialRequestOptions: Missing required challenge property');
                    }
                    
                    // Update form fields from JSON
                    updateAuthenticationFormFromJson(publicKey);
                }
                
                // Show success message
                const statusDiv = document.querySelector('#advanced-tab .status') || 
                                document.querySelector('#advanced-status');
                if (statusDiv) {
                    statusDiv.textContent = 'JSON changes saved successfully!';
                    statusDiv.className = 'status success';
                    statusDiv.style.display = 'block';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
                
            } catch (error) {
                // Show error message
                const statusDiv = document.querySelector('#advanced-tab .status') || 
                                document.querySelector('#advanced-status');
                if (statusDiv) {
                    statusDiv.textContent = `JSON validation failed: ${error.message}`;
                    statusDiv.className = 'status error';
                    statusDiv.style.display = 'block';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Reset JSON Editor to match current settings
        function resetJsonEditor() {
            updateJsonEditor();
            
            // Show reset confirmation
            const statusDiv = document.querySelector('#advanced-tab .status') || 
                            document.querySelector('#advanced-status');
            if (statusDiv) {
                statusDiv.textContent = 'JSON editor reset to current settings';
                statusDiv.className = 'status info';
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 2000);
            }
        }

        // Update registration form fields from JSON
        function updateRegistrationFormFromJson(publicKey) {
            // Update user fields
            if (publicKey.user) {
                if (publicKey.user.id && publicKey.user.id.$base64) {
                    document.getElementById('user-id').value = base64UrlToHex(publicKey.user.id.$base64);
                }
                if (publicKey.user.name) {
                    document.getElementById('user-name').value = publicKey.user.name;
                }
                if (publicKey.user.displayName) {
                    document.getElementById('user-display-name').value = publicKey.user.displayName;
                }
            }
            
            // Update challenge
            if (publicKey.challenge && publicKey.challenge.$base64) {
                document.getElementById('challenge-reg').value = base64UrlToHex(publicKey.challenge.$base64);
            }
            
            // Update timeout
            if (publicKey.timeout) {
                document.getElementById('timeout-reg').value = publicKey.timeout.toString();
            }
            
            // Update attestation
            if (publicKey.attestation) {
                document.getElementById('attestation').value = publicKey.attestation;
            }
            
            // Update authenticator selection
            if (publicKey.authenticatorSelection) {
                if (publicKey.authenticatorSelection.authenticatorAttachment) {
                    document.getElementById('authenticator-attachment').value = publicKey.authenticatorSelection.authenticatorAttachment;
                }
                if (publicKey.authenticatorSelection.residentKey) {
                    document.getElementById('resident-key').value = publicKey.authenticatorSelection.residentKey;
                }
                if (publicKey.authenticatorSelection.userVerification) {
                    document.getElementById('user-verification-reg').value = publicKey.authenticatorSelection.userVerification;
                }
            }
            
            // Update extensions
            if (publicKey.extensions) {
                if (publicKey.extensions.prf && publicKey.extensions.prf.eval) {
                    if (publicKey.extensions.prf.eval.first && publicKey.extensions.prf.eval.first.$base64) {
                        document.getElementById('prf-eval-first-reg').value = base64UrlToHex(publicKey.extensions.prf.eval.first.$base64);
                    }
                    if (publicKey.extensions.prf.eval.second && publicKey.extensions.prf.eval.second.$base64) {
                        document.getElementById('prf-eval-second-reg').value = base64UrlToHex(publicKey.extensions.prf.eval.second.$base64);
                    }
                }
            }
        }

        // Update authentication form fields from JSON
        function updateAuthenticationFormFromJson(publicKey) {
            // Update challenge
            if (publicKey.challenge && publicKey.challenge.$base64) {
                document.getElementById('challenge-auth').value = base64UrlToHex(publicKey.challenge.$base64);
            }
            
            // Update timeout
            if (publicKey.timeout) {
                document.getElementById('timeout-auth').value = publicKey.timeout.toString();
            }
            
            // Update user verification
            if (publicKey.userVerification) {
                document.getElementById('user-verification-auth').value = publicKey.userVerification;
            }
            
            // Update extensions
            if (publicKey.extensions) {
                if (publicKey.extensions.prf && publicKey.extensions.prf.eval) {
                    if (publicKey.extensions.prf.eval.first && publicKey.extensions.prf.eval.first.$base64) {
                        document.getElementById('prf-eval-first-auth').value = base64UrlToHex(publicKey.extensions.prf.eval.first.$base64);
                    }
                    if (publicKey.extensions.prf.eval.second && publicKey.extensions.prf.eval.second.$base64) {
                        document.getElementById('prf-eval-second-auth').value = base64UrlToHex(publicKey.extensions.prf.eval.second.$base64);
                    }
                }
                
                if (publicKey.extensions.largeBlob) {
                    if (publicKey.extensions.largeBlob.read) {
                        document.getElementById('large-blob-auth').value = 'read';
                    } else if (publicKey.extensions.largeBlob.write) {
                        document.getElementById('large-blob-auth').value = 'write';
                        if (publicKey.extensions.largeBlob.write.$base64) {
                            document.getElementById('large-blob-write').value = base64UrlToHex(publicKey.extensions.largeBlob.write.$base64);
                        }
                    }
                }
            }
        }

        // Convert current format value to the appropriate JSON format
        function currentFormatToJsonFormat(value) {
            if (!value) return '';
            const format = getCurrentBinaryFormat();
            
            switch (format) {
                case 'hex':
                    return {
                        "$hex": value
                    };
                case 'b64':
                    return {
                        "$base64": value
                    };
                case 'b64u':
                    return {
                        "$base64url": value
                    };
                case 'js':
                    return {
                        "$js": value
                    };
                default:
                    return {
                        "$base64url": currentFormatToBase64Url(value)
                    };
            }
        }

        // Convert current format value to base64url for JSON
        function currentFormatToBase64Url(value) {
            if (!value) return '';
            const format = getCurrentBinaryFormat();
            const hexValue = convertFormat(value, format, 'hex');
            return hexToBase64Url(hexValue);
        }

        // Get CredentialCreationOptions from form (WebAuthn standard format)
        function getCredentialCreationOptions() {
            const userId = document.getElementById('user-id')?.value || '';
            const userName = document.getElementById('user-name')?.value || '';
            const userDisplayName = document.getElementById('user-display-name')?.value || '';
            const challenge = document.getElementById('challenge-reg')?.value || '';
            
            // Build publicKey object
            const publicKey = {
                rp: {
                    name: "WebAuthn FIDO2 Test Application",
                    id: window.location.hostname
                },
                user: {
                    id: currentFormatToJsonFormat(userId),
                    name: userName,
                    displayName: userDisplayName
                },
                challenge: currentFormatToJsonFormat(challenge),
                pubKeyCredParams: [],
                timeout: parseInt(document.getElementById('timeout-reg')?.value) || 90000,
                authenticatorSelection: {},
                attestation: document.getElementById('attestation')?.value || 'none',
                extensions: {}
            };

            // Add selected algorithms
            if (document.getElementById('param-eddsa')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -8}); // EdDSA
            }
            if (document.getElementById('param-es256')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -7}); // ES256
            }
            if (document.getElementById('param-rs256')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -257}); // RS256
            }
            if (document.getElementById('param-es384')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -35}); // ES384
            }
            if (document.getElementById('param-es512')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -36}); // ES512
            }
            if (document.getElementById('param-rs384')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -258}); // RS384
            }
            if (document.getElementById('param-rs512')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -259}); // RS512
            }
            if (document.getElementById('param-rs1')?.checked) {
                publicKey.pubKeyCredParams.push({type: "public-key", alg: -65535}); // RS1
            }

            // Authenticator selection
            const authAttachment = document.getElementById('authenticator-attachment')?.value;
            if (authAttachment) publicKey.authenticatorSelection.authenticatorAttachment = authAttachment;
            
            const residentKey = document.getElementById('resident-key')?.value;
            if (residentKey && residentKey !== 'discouraged') publicKey.authenticatorSelection.residentKey = residentKey;
            
            const userVerification = document.getElementById('user-verification-reg')?.value;
            if (userVerification) publicKey.authenticatorSelection.userVerification = userVerification;

            // Exclude credentials
            if (document.getElementById('exclude-credentials')?.checked && storedCredentials.length > 0) {
                publicKey.excludeCredentials = storedCredentials.map(cred => ({
                    type: "public-key",
                    id: {
                        "$base64url": hexToBase64Url(cred.credentialId)
                    }
                }));
            }

            // Extensions
            if (document.getElementById('cred-props')?.checked) publicKey.extensions.credProps = true;
            if (document.getElementById('min-pin-length')?.checked) publicKey.extensions.minPinLength = true;
            
            const credProtect = document.getElementById('cred-protect')?.value;
            if (credProtect) {
                publicKey.extensions.credProtect = credProtect;
                if (document.getElementById('enforce-cred-protect')?.checked) {
                    publicKey.extensions.enforceCredProtect = true;
                }
            }
            
            const largeBlobReg = document.getElementById('large-blob-reg')?.value;
            if (largeBlobReg) publicKey.extensions.largeBlob = {support: largeBlobReg};
            
            if (document.getElementById('prf-reg')?.checked) {
                const prfFirst = document.getElementById('prf-eval-first-reg')?.value;
                const prfSecond = document.getElementById('prf-eval-second-reg')?.value;
                if (prfFirst) {
                    publicKey.extensions.prf = {
                        eval: {
                            first: currentFormatToJsonFormat(prfFirst)
                        }
                    };
                    if (prfSecond) {
                        publicKey.extensions.prf.eval.second = currentFormatToJsonFormat(prfSecond);
                    }
                }
            }

            // Add hints if any are selected
            const hints = [];
            if (document.getElementById('hint-client-device')?.checked) hints.push('client-device');
            if (document.getElementById('hint-hybrid')?.checked) hints.push('hybrid');
            if (document.getElementById('hint-security-key')?.checked) hints.push('security-key');
            if (hints.length > 0) publicKey.hints = hints;

            return { publicKey };
        }

        // Get CredentialRequestOptions from form (WebAuthn standard format)
        function getCredentialRequestOptions() {
            const challenge = document.getElementById('challenge-auth')?.value || '';
            
            // Build publicKey object  
            const publicKey = {
                challenge: currentFormatToJsonFormat(challenge),
                timeout: parseInt(document.getElementById('timeout-auth')?.value) || 90000,
                rpId: window.location.hostname,
                allowCredentials: [],
                userVerification: document.getElementById('user-verification-auth')?.value || 'preferred',
                extensions: {}
            };

            // Allow credentials handling
            const allowCreds = document.getElementById('allow-credentials')?.value;
            if (allowCreds === 'empty') {
                // Omit allowCredentials parameter entirely for resident key authentication
                // This enables discoverable credential authentication
                delete publicKey.allowCredentials;
            } else if (allowCreds === 'all') {
                // Include all stored credentials
                publicKey.allowCredentials = storedCredentials.map(cred => ({
                    type: "public-key",
                    id: {
                        "$base64url": hexToBase64Url(cred.credentialId)
                    }
                }));
            } else {
                // Specific credential selected - find it by credential ID
                const selectedCred = storedCredentials.find(cred => cred.credentialId === allowCreds);
                if (selectedCred) {
                    publicKey.allowCredentials = [{
                        type: "public-key",
                        id: {
                            "$base64url": hexToBase64Url(selectedCred.credentialId)
                        }
                    }];
                } else {
                    // Fallback to all credentials if specific one not found
                    publicKey.allowCredentials = storedCredentials.map(cred => ({
                        type: "public-key",
                        id: {
                            "$base64url": hexToBase64Url(cred.credentialId)
                        }
                    }));
                }
            }

            // Extensions
            const largeBlobAuth = document.getElementById('large-blob-auth')?.value;
            if (largeBlobAuth) {
                if (largeBlobAuth === 'read') {
                    publicKey.extensions.largeBlob = {read: true};
                } else if (largeBlobAuth === 'write') {
                    const largeBlobWrite = document.getElementById('large-blob-write')?.value;
                    if (largeBlobWrite) {
                        publicKey.extensions.largeBlob = {
                            write: currentFormatToJsonFormat(largeBlobWrite)
                        };
                    }
                }
            }
            
            const prfFirst = document.getElementById('prf-eval-first-auth')?.value;
            const prfSecond = document.getElementById('prf-eval-second-auth')?.value;
            if (prfFirst) {
                publicKey.extensions.prf = {
                    eval: {
                        first: currentFormatToJsonFormat(prfFirst)
                    }
                };
                if (prfSecond) {
                    publicKey.extensions.prf.eval.second = currentFormatToJsonFormat(prfSecond);
                }
            }

            // Add hints if any are selected
            const hints = [];
            if (document.getElementById('hint-client-device-auth')?.checked) hints.push('client-device');
            if (document.getElementById('hint-hybrid-auth')?.checked) hints.push('hybrid');  
            if (document.getElementById('hint-security-key-auth')?.checked) hints.push('security-key');
            if (hints.length > 0) publicKey.hints = hints;

            return { publicKey };
        }

        // Utility functions
        function showStatus(tabId, message, type) {
            const statusEl = document.getElementById(tabId + '-status');
            statusEl.className = 'status ' + type;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                hideStatus(tabId);
            }, 5000);
        }

        function hideStatus(tabId) {
            document.getElementById(tabId + '-status').style.display = 'none';
        }

        function showProgress(tabId, message) {
            const progressEl = document.getElementById(tabId + '-progress');
            const textEl = document.getElementById(tabId + '-progress-text');
            textEl.textContent = message;
            progressEl.classList.add('show');
        }

        function hideProgress(tabId) {
            document.getElementById(tabId + '-progress').classList.remove('show');
        }

        // Simple authentication functions (keeping existing functionality)
        async function simpleRegister() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting registration...');

                const response = await fetch('/api/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email}),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                const createOptions = parseCreationOptionsFromJSON(json);

                showProgress('simple', 'Connecting your authenticator device...');

                const credential = await create(createOptions);
                
                showProgress('simple', 'Completing registration...');

                const result = await fetch('/api/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        response: credential
                    }),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('simple', `Registration successful! Algorithm: ${data.algo || 'Unknown'}`, 'success');
                    
                    // Add to credentials list
                    addCredentialToList({
                        type: 'simple',
                        email: email,
                        credentialId: credential.id,
                        algorithm: data.algo || 'Unknown'
                    });
                } else {
                    throw new Error('Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showStatus('simple', `Registration failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        async function simpleAuthenticate() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting authentication...');

                const response = await fetch('/api/authenticate/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email}),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                const getOptions = parseRequestOptionsFromJSON(json);

                showProgress('simple', 'Connecting your authenticator device...');

                const assertion = await get(getOptions);
                
                showProgress('simple', 'Completing authentication...');

                const result = await fetch('/api/authenticate/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        response: assertion
                    }),
                });

                if (result.ok) {
                    showStatus('simple', 'Authentication successful!', 'success');
                } else {
                    throw new Error('Authentication failed');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showStatus('simple', `Authentication failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        // Credentials management
        function addCredentialToList(credential) {
            storedCredentials.push(credential);
            updateCredentialsList();
        }

        function updateCredentialsList() {
            const list = document.getElementById('credentials-list');
            
            if (storedCredentials.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; font-style: italic;">No credentials registered yet.</p>';
                return;
            }

            list.innerHTML = '';
            storedCredentials.forEach((cred, index) => {
                const credItem = document.createElement('div');
                credItem.className = 'credential-item';
                credItem.onclick = () => toggleCredentialDetails(index);
                
                let summary = '';
                if (cred.type === 'simple') {
                    summary = cred.email || cred.username;
                } else {
                    summary = `${cred.userName || cred.userId}`;
                    if (cred.displayName) summary += `\n${cred.displayName}`;
                }
                
                credItem.innerHTML = `
                    <div class="credential-summary">${summary}</div>
                    <div class="credential-details">
                        ${generateCredentialDetails(cred)}
                        <button class="credential-delete" onclick="deleteCredential(${index}); event.stopPropagation();">Delete</button>
                    </div>
                `;
                
                list.appendChild(credItem);
            });
        }

        function generateCredentialDetails(cred) {
            if (cred.type === 'simple') {
                return `
                    <strong>Type:</strong> Simple Authentication<br>
                    <strong>User:</strong> ${cred.email || cred.username}<br>
                    <strong>Credential ID:</strong> ${cred.credentialId}<br>
                    <strong>Algorithm:</strong> ${cred.algorithm}
                `;
            } else {
                return `
                    <strong>Type:</strong> Advanced Authentication<br>
                    <strong>User ID:</strong> ${cred.userId}<br>
                    <strong>User Name:</strong> ${cred.userName}<br>
                    <strong>Display Name:</strong> ${cred.displayName || 'N/A'}<br>
                    <strong>Credential ID:</strong> ${cred.credentialId}<br>
                    <strong>Algorithm:</strong> ${cred.algorithm}
                `;
            }
        }

        function toggleCredentialDetails(index) {
            const credItems = document.querySelectorAll('.credential-item');
            const item = credItems[index];
            
            if (item.classList.contains('expanded')) {
                item.classList.remove('expanded');
            } else {
                // Close all others
                credItems.forEach(item => item.classList.remove('expanded'));
                // Open this one
                item.classList.add('expanded');
            }
        }





        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize binary format system
            window.currentBinaryFormat = 'hex';
            updateFieldLabels('hex');
            
            // Initialize with default hex values as requested
            setTimeout(() => {
                // Generate default hex values for userid, challenge, and largeblob write
                document.getElementById('user-id').value = generateRandomHex(32);
                document.getElementById('user-name').value = '';
                document.getElementById('user-display-name').value = '';
                document.getElementById('challenge-reg').value = generateRandomHex(32);
                document.getElementById('challenge-auth').value = generateRandomHex(32);
                document.getElementById('large-blob-write').value = generateRandomHex(32);
                document.getElementById('prf-eval-first-reg').value = '';
                document.getElementById('prf-eval-second-reg').value = '';
                document.getElementById('prf-eval-first-auth').value = '';
                document.getElementById('prf-eval-second-auth').value = '';
                
                // Load saved credentials
                loadSavedCredentials();
                
                // Update JSON editor with initial values
                updateJsonEditor();
            }, 100);
            
            // Set up form field listeners for auto-sync
            setTimeout(() => {
                const allInputs = document.querySelectorAll('#advanced-tab input, #advanced-tab select, #advanced-tab input[type="checkbox"]');
                allInputs.forEach(input => {
                    input.addEventListener('input', updateJsonEditor);
                    input.addEventListener('change', updateJsonEditor);
                });

                // Set up display name sync with username
                const usernameInput = document.getElementById('user-name');
                const displayNameInput = document.getElementById('user-display-name');
                if (usernameInput && displayNameInput) {
                    usernameInput.addEventListener('input', () => {
                        displayNameInput.value = usernameInput.value;
                        updateJsonEditor();
                    });
                }

                // Set up large blob select listener
                const largeBlobSelect = document.getElementById('large-blob-auth');
                if (largeBlobSelect) {
                    largeBlobSelect.addEventListener('change', () => {
                        checkLargeBlobCapability(); // Re-check to enable/disable write input
                        updateJsonEditor();
                    });
                }

                // Set up allow credentials dropdown listener
                const allowCredentialsSelect = document.getElementById('allow-credentials');
                if (allowCredentialsSelect) {
                    allowCredentialsSelect.addEventListener('change', () => {
                        updateJsonEditor();
                    });
                }

                // Set up resident key dependency for largeBlob
                const residentKeySelect = document.getElementById('resident-key');
                const largeBlobRegSelect = document.getElementById('large-blob-reg');
                if (residentKeySelect && largeBlobRegSelect) {
                    residentKeySelect.addEventListener('change', () => {
                        const residentKey = residentKeySelect.value;
                        if (residentKey !== 'required') {
                            // If resident key is not required, disable largeBlob preferred/required options
                            const largeBlobValue = largeBlobRegSelect.value;
                            if (largeBlobValue === 'preferred' || largeBlobValue === 'required') {
                                largeBlobRegSelect.value = ''; // Reset to unspecified
                            }
                        }
                        updateJsonEditor();
                    });
                }

                // Set up modal close on outside click
                const modal = document.getElementById('credentialModal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeCredentialModal();
                        }
                    });
                }
                
                // Set up specific PRF validation listeners
                const prfFirstInputs = ['prf-eval-first-reg', 'prf-eval-first-auth'];
                prfFirstInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            const formType = inputId.includes('reg') ? 'reg' : 'auth';
                            validatePrfInputs(formType);
                            validatePrfEvalInputs();
                        });
                        input.addEventListener('change', () => {
                            const formType = inputId.includes('reg') ? 'reg' : 'auth';
                            validatePrfInputs(formType);
                            validatePrfEvalInputs();
                        });
                    }
                });

                // Set up validation listeners for hex inputs
                const hexInputs = [
                    'user-id', 'challenge-reg', 'challenge-auth',
                    'prf-eval-first-reg', 'prf-eval-second-reg',
                    'prf-eval-first-auth', 'prf-eval-second-auth',
                    'large-blob-write'
                ];
                hexInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            if (inputId === 'user-id') validateUserIdInput();
                            else if (inputId.includes('challenge')) validateChallengeInputs();
                            else if (inputId.includes('prf-eval')) validatePrfEvalInputs();
                            else if (inputId === 'large-blob-write') validateLargeBlobWriteInput();
                        });
                        input.addEventListener('blur', () => {
                            if (inputId === 'user-id') validateUserIdInput();
                            else if (inputId.includes('challenge')) validateChallengeInputs();
                            else if (inputId.includes('prf-eval')) validatePrfEvalInputs();
                            else if (inputId === 'large-blob-write') validateLargeBlobWriteInput();
                        });
                    }
                });
            }, 100);
            
            // Initialize JSON editor
            setTimeout(updateJsonEditor, 200);
            
            // Load saved credentials
            setTimeout(loadSavedCredentials, 300);
            
            // Ensure decoder tab functionality is properly initialized
            setTimeout(() => {
                // Verify decoder elements exist
                const decoderTab = document.getElementById('decoder-tab');
                const decoderInput = document.getElementById('decoder-input');
                const decoderOutput = document.getElementById('decoder-output');
                
                if (window.console && console.log) {
                    console.log('Decoder tab elements check:');
                    console.log('decoder-tab:', !!decoderTab);
                    console.log('decoder-input:', !!decoderInput);
                    console.log('decoder-output:', !!decoderOutput);
                }
                
                // Test switchTab function with decoder
                if (window.console && console.log) {
                    console.log('Testing decoder tab activation...');
                }
            }, 500);
        });

        // Make functions globally available
        window.switchTab = switchTab;
        window.switchSubTab = switchSubTab;
        window.toggleSection = toggleSection;
        window.randomizeUserId = randomizeUserId;
        window.randomizeChallenge = randomizeChallenge;
        window.randomizePrfEval = randomizePrfEval;
        window.randomizeLargeBlobWrite = randomizeLargeBlobWrite;
        window.resetRegistrationForm = resetRegistrationForm;
        window.resetAuthenticationForm = resetAuthenticationForm;
        window.simpleRegister = simpleRegister;
        window.simpleAuthenticate = simpleAuthenticate;
        window.advancedRegister = advancedRegister;
        window.advancedAuthenticate = advancedAuthenticate;
        window.decodeResponse = decodeResponse;
        window.clearDecoder = clearDecoder;
        window.changeBinaryFormat = changeBinaryFormat;
        window.saveJsonEditor = saveJsonEditor;
        window.resetJsonEditor = resetJsonEditor;
        window.showCredentialDetails = showCredentialDetails;
        window.closeCredentialModal = closeCredentialModal;
        window.deleteCredential = deleteCredential;

        function showProgress(tabId, message) {
            const progressEl = document.getElementById(tabId + '-progress');
            const textEl = document.getElementById(tabId + '-progress-text');
            textEl.textContent = message;
            progressEl.classList.add('show');
        }

        function hideProgress(tabId) {
            document.getElementById(tabId + '-progress').classList.remove('show');
        }

        // Simple Authentication Functions
        async function simpleRegister() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting registration...');

                const request = await fetch(`/api/register/begin?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                });

                if (!request.ok) {
                    throw new Error(`HTTP ${request.status}: ${request.statusText}`);
                }

                const json = await request.json();
                const options = parseCreationOptionsFromJSON(json);
                
                showProgress('simple', 'Connecting your authenticator device...');

                const response = await create(options);
                
                showProgress('simple', 'Completing registration...');

                const result = await fetch(`/api/register/complete?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(response),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('simple', `Registration successful! Algorithm used: ${data.algo}`, 'success');
                } else {
                    throw new Error('Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showStatus('simple', `Registration failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        async function simpleAuthenticate() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Starting authentication...');

                const request = await fetch(`/api/authenticate/begin?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                });

                if (!request.ok) {
                    if (request.status === 404) {
                        throw new Error('No credentials found for this email. Please register first.');
                    }
                    throw new Error(`HTTP ${request.status}: ${request.statusText}`);
                }

                const json = await request.json();
                const options = parseRequestOptionsFromJSON(json);
                
                showProgress('simple', 'Connecting your authenticator device...');

                const response = await get(options);
                
                showProgress('simple', 'Completing authentication...');

                const result = await fetch(`/api/authenticate/complete?email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(response),
                });

                if (result.ok) {
                    showStatus('simple', 'Authentication successful!', 'success');
                } else {
                    throw new Error('Authentication failed');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showStatus('simple', `Authentication failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        async function simpleDelete() {
            const email = document.getElementById('simple-email').value;
            if (!email) {
                showStatus('simple', 'Please enter an email address', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete all credentials for ${email}?`)) {
                return;
            }

            try {
                hideStatus('simple');
                showProgress('simple', 'Deleting credentials...');

                const result = await fetch('/api/deletepub', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"email": email}),
                });

                if (result.ok) {
                    showStatus('simple', 
                        'Credentials deleted from server successfully! ' +
                        'Note: This only removes credentials from our application. ' +
                        'Resident key credentials remain on your authenticator device. ' +
                        'To fully remove credentials, you may need to reset your authenticator.', 
                        'success'
                    );
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                console.error('Deletion error:', error);
                showStatus('simple', `Deletion failed: ${error.message}`, 'error');
            } finally {
                hideProgress('simple');
            }
        }

        // Advanced Authentication Functions
        function getAdvancedCreateOptions() {
            // Collect basic user information
            const options = {
                username: document.getElementById('user-name').value,
                displayName: document.getElementById('user-display-name').value || document.getElementById('user-name').value,
                userId: document.getElementById('user-id').value,
                
                // Authenticator selection
                attestation: document.getElementById('attestation').value,
                userVerification: document.getElementById('user-verification-reg').value,
                authenticatorAttachment: document.getElementById('authenticator-attachment').value || undefined,
                residentKey: document.getElementById('resident-key').value,
                
                // Credential management
                excludeCredentials: document.getElementById('exclude-credentials').checked,
                fakeCredLength: parseInt(document.getElementById('fake-cred-length-reg').value) || 0,
                
                // Other options
                challenge: document.getElementById('challenge-reg').value,
                timeout: parseInt(document.getElementById('timeout-reg').value) || 90000,
                
                // Public key credential parameters
                pubKeyCredParams: [],
                
                // Hints
                hints: [],
                
                // Extensions
                extensions: {}
            };
            
            // Collect selected algorithms
            if (document.getElementById('param-eddsa')?.checked) options.pubKeyCredParams.push('EdDSA');
            if (document.getElementById('param-es256')?.checked) options.pubKeyCredParams.push('ES256');
            if (document.getElementById('param-rs256')?.checked) options.pubKeyCredParams.push('RS256');
            if (document.getElementById('param-es384')?.checked) options.pubKeyCredParams.push('ES384');
            if (document.getElementById('param-es512')?.checked) options.pubKeyCredParams.push('ES512');
            if (document.getElementById('param-rs384')?.checked) options.pubKeyCredParams.push('RS384');
            if (document.getElementById('param-rs512')?.checked) options.pubKeyCredParams.push('RS512');
            if (document.getElementById('param-rs1')?.checked) options.pubKeyCredParams.push('RS1');
            
            // Collect hints
            if (document.getElementById('hint-client-device')?.checked) options.hints.push('client-device');
            if (document.getElementById('hint-hybrid')?.checked) options.hints.push('hybrid');
            if (document.getElementById('hint-security-key')?.checked) options.hints.push('security-key');
            
            // Collect extensions
            if (document.getElementById('cred-props')?.checked) {
                options.extensions.credProps = true;
            }
            
            if (document.getElementById('min-pin-length')?.checked) {
                options.extensions.minPinLength = true;
            }
            
            const credProtect = document.getElementById('cred-protect')?.value;
            if (credProtect && credProtect !== '') {
                options.extensions.credProtect = credProtect;
                if (document.getElementById('enforce-cred-protect')?.checked) {
                    options.extensions.enforceCredProtect = true;
                }
            }
            
            const largeBlob = document.getElementById('large-blob-reg')?.value;
            if (largeBlob && largeBlob !== '') {
                options.extensions.largeBlob = largeBlob;
            }
            
            if (document.getElementById('prf-reg')?.checked) {
                options.extensions.prf = true;
                const prfFirst = document.getElementById('prf-eval-first-reg')?.value;
                const prfSecond = document.getElementById('prf-eval-second-reg')?.value;
                if (prfFirst) options.extensions.prfEvalFirst = prfFirst;
                if (prfSecond) options.extensions.prfEvalSecond = prfSecond;
            }
            
            return options;
        }

        function getAdvancedAssertOptions() {
            const allowCreds = document.getElementById('allow-credentials').value;
            console.log('=== FRONTEND AUTHENTICATION OPTIONS DEBUG ===');
            console.log('Allow credentials dropdown value:', allowCreds);
            
            const options = {
                userVerification: document.getElementById('user-verification-auth').value,
                allowCredentials: allowCreds,
                fakeCredLength: parseInt(document.getElementById('fake-cred-length-auth').value) || 0,
                challenge: document.getElementById('challenge-auth').value,
                timeout: parseInt(document.getElementById('timeout-auth').value) || 90000,
                extensions: {}
            };
            
            // Handle specific credential selection
            if (allowCreds !== 'all' && allowCreds !== 'empty') {
                // This is a specific credential ID
                options.specificCredentialId = allowCreds;
                console.log('Specific credential ID selected:', allowCreds);
            } else if (allowCreds === 'empty') {
                console.log('*** EMPTY allowCredentials selected - this should enable resident key mode ***');
            } else {
                console.log('All credentials selected');
            }
            
            // Collect extensions for authentication
            const largeBlob = document.getElementById('large-blob-auth')?.value;
            if (largeBlob && largeBlob !== '') {
                options.extensions.largeBlob = largeBlob;
                if (largeBlob === 'write') {
                    const largeBlobWrite = document.getElementById('large-blob-write')?.value;
                    if (largeBlobWrite) {
                        options.extensions.largeBlobWrite = largeBlobWrite;
                    }
                }
            }
            
            // Check if we have prf inputs for authentication
            const prfFirst = document.getElementById('prf-eval-first-auth')?.value;
            const prfSecond = document.getElementById('prf-eval-second-auth')?.value;
            if (prfFirst || prfSecond) {
                options.extensions.prf = true;
                if (prfFirst) options.extensions.prfEvalFirst = prfFirst;
                if (prfSecond) options.extensions.prfEvalSecond = prfSecond;
            }
            
            return options;
        }

        async function advancedRegister() {
            // Validate all inputs first
            const isUserIdValid = validateUserIdInput();
            const isChallengeValid = validateChallengeInputs();
            const isPrfValid = validatePrfEvalInputs();
            const isLargeBlobValid = validateLargeBlobWriteInput();
            const isLargeBlobDependencyValid = validateLargeBlobDependency();
            
            if (!isUserIdValid || !isChallengeValid || !isPrfValid || !isLargeBlobValid || !isLargeBlobDependencyValid) {
                showStatus('advanced', 'Please fix the validation errors above', 'error');
                return;
            }

            const options = getAdvancedCreateOptions();
            if (!options.username) {
                showStatus('advanced', 'Please enter a username', 'error');
                return;
            }

            try {
                hideStatus('advanced');
                showProgress('advanced', 'Starting advanced registration...');

                const response = await fetch('/api/advanced/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(options)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }

                const json = await response.json();
                const createOptions = parseCreationOptionsFromJSON(json);
                
                showProgress('advanced', 'Connecting your authenticator device...');

                const credential = await create(createOptions);
                
                showProgress('advanced', 'Completing registration...');

                const result = await fetch('/api/advanced/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ...options,
                        response: credential
                    }),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('advanced', `Advanced registration successful! Algorithm: ${data.algo || 'Unknown'}`, 'success');
                    
                    // Reload credentials from server to get the latest
                    setTimeout(loadSavedCredentials, 1000);
                } else {
                    const errorText = await result.text();
                    throw new Error(`Registration failed: ${errorText}`);
                }
            } catch (error) {
                console.error('Advanced registration error:', error);
                
                let errorMessage = error.message;
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'User cancelled or authenticator not available';
                } else if (error.name === 'InvalidStateError') {
                    errorMessage = 'Authenticator is already registered for this account';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Security error - check your connection and try again';
                }
                
                showStatus('advanced', `Advanced registration failed: ${errorMessage}`, 'error');
            } finally {
                hideProgress('advanced');
            }
        }

        async function advancedAuthenticate() {
            // Validate all inputs first
            const isChallengeValid = validateChallengeInputs();
            const isPrfValid = validatePrfEvalInputs();
            const isLargeBlobValid = validateLargeBlobWriteInput();
            
            if (!isChallengeValid || !isPrfValid || !isLargeBlobValid) {
                showStatus('advanced', 'Please fix the validation errors above', 'error');
                return;
            }

            // Check for resident key authentication without resident key credentials
            const allowCreds = document.getElementById('allow-credentials')?.value;
            if (allowCreds === 'empty') {
                const hasResidentKeyCredentials = storedCredentials && storedCredentials.some(cred => 
                    cred.residentKey === true || 
                    (cred.clientExtensionOutputs && cred.clientExtensionOutputs.credProps && cred.clientExtensionOutputs.credProps.rk === true)
                );
                
                if (!hasResidentKeyCredentials) {
                    showStatus('advanced', 
                        'Warning: Resident key authentication selected but no resident key credentials found. ' +
                        'Please register a credential with Resident Key set to "Required" first, or select a specific credential instead.', 
                        'error'
                    );
                    return;
                }
                
                console.log('Resident key authentication mode - found compatible credentials');
            }

            const options = getAdvancedAssertOptions();
            console.log('Final options being sent to server:', JSON.stringify(options, null, 2));

            try {
                hideStatus('advanced');
                showProgress('advanced', 'Detecting credentials...');

                const response = await fetch('/api/advanced/authenticate/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(options)
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('No credentials detected. Please register a credential first.');
                    }
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }

                const json = await response.json();
                console.log('Server response for authentication options:', JSON.stringify(json, null, 2));
                
                const assertOptions = parseRequestOptionsFromJSON(json);
                console.log('Parsed assertOptions for WebAuthn API:', JSON.stringify(assertOptions, null, 2));
                console.log('allowCredentials in assertOptions:', assertOptions.allowCredentials);
                console.log('allowCredentials type:', typeof assertOptions.allowCredentials);
                console.log('allowCredentials is undefined:', assertOptions.allowCredentials === undefined);
                
                // CRITICAL FIX: Ensure allowCredentials is completely omitted for resident key authentication
                // The webauthn-json library might be adding an empty array even when the server omits the parameter
                if (options.allowCredentials === 'empty' && assertOptions.allowCredentials !== undefined) {
                    console.log('*** FIXING: webauthn-json added allowCredentials, removing it for resident key mode ***');
                    delete assertOptions.allowCredentials;
                    console.log('After fix - allowCredentials in assertOptions:', assertOptions.allowCredentials);
                }
                
                showProgress('advanced', 'Connecting your authenticator device...');

                const assertion = await get(assertOptions);
                
                showProgress('advanced', 'Completing authentication...');

                const result = await fetch('/api/advanced/authenticate/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        response: assertion
                    }),
                });

                if (result.ok) {
                    const data = await result.json();
                    showStatus('advanced', 'Advanced authentication successful!', 'success');
                } else {
                    const errorText = await result.text();
                    throw new Error(`Authentication failed: ${errorText}`);
                }
            } catch (error) {
                console.error('Advanced authentication error:', error);
                
                let errorMessage = error.message;
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'User cancelled or no compatible authenticator detected';
                } else if (error.name === 'InvalidStateError') {
                    errorMessage = 'Invalid authenticator state - please try again';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Security error - check your connection and try again';
                }
                
                showStatus('advanced', `Advanced authentication failed: ${errorMessage}`, 'error');
            } finally {
                hideProgress('advanced');
            }
        }

        async function advancedDelete() {
            const username = document.getElementById('user-name').value;
            if (!username) {
                showStatus('advanced', 'Please enter a username', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete all credentials for ${username}?`)) {
                return;
            }

            try {
                hideStatus('advanced');
                showProgress('advanced', 'Deleting credentials...');

                const result = await fetch('/api/deletepub', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"username": username}),
                });

                if (result.ok) {
                    showStatus('advanced', 
                        'Credentials deleted from server successfully! ' +
                        'Note: This only removes credentials from our application. ' +
                        'Resident key credentials remain on your authenticator device. ' +
                        'To fully remove credentials, you may need to reset your authenticator.', 
                        'success'
                    );
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                console.error('Deletion error:', error);
                showStatus('advanced', `Deletion failed: ${error.message}`, 'error');
            } finally {
                hideProgress('advanced');
            }
        }

        // JSON Editor Functions
        function editCreateOptions() {
            const options = getAdvancedCreateOptions();
            currentJsonMode = 'create';
            currentJsonData = options;
            
            document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
            document.getElementById('apply-json').style.display = 'inline-block';
            document.getElementById('cancel-json').style.display = 'inline-block';
        }

        function editAssertOptions() {
            const options = getAdvancedAssertOptions();
            currentJsonMode = 'assert';
            currentJsonData = options;
            
            document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
            document.getElementById('apply-json').style.display = 'inline-block';
            document.getElementById('cancel-json').style.display = 'inline-block';
        }

        function applyJsonChanges() {
            try {
                const jsonText = document.getElementById('json-editor').value;
                const parsed = JSON.parse(jsonText);
                
                if (currentJsonMode === 'create') {
                    // Update create form fields
                    if (parsed.username) document.getElementById('user-name').value = parsed.username;
                    if (parsed.displayName) document.getElementById('user-display-name').value = parsed.displayName;
                    if (parsed.attestation) document.getElementById('attestation').value = parsed.attestation;
                    if (parsed.userVerification) document.getElementById('user-verification-reg').value = parsed.userVerification;
                    if (parsed.authenticatorAttachment !== undefined) document.getElementById('authenticator-attachment').value = parsed.authenticatorAttachment || '';
                    if (parsed.residentKey) document.getElementById('resident-key').value = parsed.residentKey;
                } else if (currentJsonMode === 'assert') {
                    // Update assert form fields
                    if (parsed.userVerification) document.getElementById('user-verification-auth').value = parsed.userVerification;
                }
                
                showStatus('advanced', 'JSON changes applied successfully!', 'success');
                cancelJsonEdit();
            } catch (error) {
                showStatus('advanced', `Invalid JSON: ${error.message}`, 'error');
            }
        }

        function cancelJsonEdit() {
            document.getElementById('json-editor').value = '';
            document.getElementById('apply-json').style.display = 'none';
            document.getElementById('cancel-json').style.display = 'none';
            currentJsonMode = null;
            currentJsonData = {};
        }

        // Decoder Functions
        function decodeResponse() {
            const input = document.getElementById('decoder-input');
            if (!input) {
                if (window.console && console.error) {
                    console.error('Decoder input element not found');
                }
                return;
            }
            
            const inputValue = input.value;
            if (!inputValue.trim()) {
                showStatus('decoder', 'Please paste a WebAuthn response to decode', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(inputValue);
                const decoded = analyzeWebAuthnResponse(parsed);
                
                const decodedContent = document.getElementById('decoded-content');
                const decoderOutput = document.getElementById('decoder-output');
                
                if (decodedContent && decoderOutput) {
                    decodedContent.innerHTML = `<pre>${JSON.stringify(decoded, null, 2)}</pre>`;
                    decoderOutput.style.display = 'block';
                    showStatus('decoder', 'Response decoded successfully!', 'success');
                } else {
                    if (window.console && console.error) {
                        console.error('Decoder output elements not found');
                    }
                }
            } catch (error) {
                showStatus('decoder', `Decoding failed: ${error.message}`, 'error');
            }
        }

        function clearDecoder() {
            const input = document.getElementById('decoder-input');
            const output = document.getElementById('decoder-output');
            
            if (input) {
                input.value = '';
            }
            if (output) {
                output.style.display = 'none';
            }
            hideStatus('decoder');
        }

        function analyzeWebAuthnResponse(response) {
            const analysis = {
                type: 'Unknown',
                rawResponse: response,
                decodedFields: {}
            };

            // Detect if it's a registration or authentication response
            if (response.response && response.response.attestationObject) {
                analysis.type = 'Registration Response';
                analysis.decodedFields = {
                    credentialId: response.id,
                    credentialType: response.type,
                    authenticatorAttachment: response.authenticatorAttachment,
                    clientDataJSON: tryDecodeBase64Url(response.response.clientDataJSON),
                    attestationObject: 'Base64URL encoded - contains authenticator data and attestation statement'
                };
            } else if (response.response && response.response.authenticatorData) {
                analysis.type = 'Authentication Response';
                analysis.decodedFields = {
                    credentialId: response.id,
                    credentialType: response.type,
                    authenticatorAttachment: response.authenticatorAttachment,
                    clientDataJSON: tryDecodeBase64Url(response.response.clientDataJSON),
                    authenticatorData: 'Base64URL encoded - contains RP ID hash, flags, counter, etc.',
                    signature: 'Base64URL encoded signature'
                };
            }

            return analysis;
        }

        function tryDecodeBase64Url(encoded) {
            try {
                const decoded = atob(encoded.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch (error) {
                return 'Could not decode as JSON: ' + encoded;
            }
        }

        // Update JSON editor when form fields change
        document.addEventListener('DOMContentLoaded', function() {
            const formFields = [
                'user-name', 'user-display-name', 'attestation',
                'user-verification-reg', 'authenticator-attachment', 'resident-key',
                'user-verification-auth'
            ];

            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateJsonFromForm);
                    field.addEventListener('change', updateJsonFromForm);
                }
            });
        });

        function updateJsonFromForm() {
            if (currentJsonMode) {
                if (currentJsonMode === 'create') {
                    const options = getAdvancedCreateOptions();
                    document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
                } else if (currentJsonMode === 'assert') {
                    const options = getAdvancedAssertOptions();
                    document.getElementById('json-editor').value = JSON.stringify(options, null, 2);
                }
            }
        }
    </script>

    <!-- Credential Details Modal -->
    <div id="credentialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Credential Details</h2>
                <button class="modal-close" onclick="closeCredentialModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>